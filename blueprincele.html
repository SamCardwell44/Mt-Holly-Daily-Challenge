<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blue Prince Daily Challenge</title>
    <style>
        body {
            font-family: 'Georgia', serif;
            background: #1a1a1a;
            color: #fff;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #2a2a2a;
            border-radius: 15px;
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #f4f4f4;
            margin-bottom: 30px;
        }
        
        .game-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .mode-select, .resources {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button.active {
            background: #9C27B0;
        }
        
        .resources {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
        }
        
        .resource-item {
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 0 10px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .resource-item:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .resource-item.selected {
            background: rgba(255,255,255,0.3);
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        .grid-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(5, 80px);
            grid-template-rows: repeat(7, 80px);
            gap: 5px;
            background: #1a1a1a;
            padding: 20px;
            border-radius: 15px;
        }
        
        .cell {
            width: 80px;
            height: 80px;
            border: 2px solid #444;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
            font-size: 10px;
            text-align: center;
            transition: all 0.3s ease;
            overflow: hidden;
            background: #2E2E2E;
        }
        
        .cell:hover {
            border-color: #fff;
            transform: scale(1.05);
        }
        
        .cell.lobby {
            background: #4CAF50;
            border-color: #45a049;
        }
        
        .cell.goal {
            background: #9C27B0;
            border-color: #8E24AA;
        }
        
        .cell.completed {
            background: #66BB6A;
            border-color: #4CAF50;
        }
        
        .cell.locked {
            background: #424242;
            border-color: #616161;
        }
        
        .cell {
            background: #2E2E2E;
        }
        
        .cell.yellow { border-color: #FFC107; border-width: 3px; }
        .cell.blue { border-color: #2196F3; border-width: 3px; }
        .cell.green { border-color: #4CAF50; border-width: 3px; }
        .cell.red { border-color: #F44336; border-width: 3px; }
        .cell.orange { border-color: #FF9800; border-width: 3px; }
        
        .cell.path {
            box-shadow: 0 0 20px rgba(0,255,136,0.8);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(0,255,136,0.8); }
            50% { box-shadow: 0 0 30px rgba(0,255,136,1); }
        }
        
        .resource-icon {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 12px;
        }
        
        .challenge-text {
            font-size: 9px;
            line-height: 1.1;
            padding: 2px;
        }
        
        .hidden-challenge {
            color: #888;
            font-size: 20px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
            text-align: center;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }
        
        .modal-content {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        
        .draft-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .draft-option {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .draft-option:hover {
            background: rgba(255,255,255,0.3);
            border-color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè∞ Blue Prince Daily Challenge</h1>
        
        <div class="game-controls">
            <div class="mode-select">
                <button id="daily-std" class="mode-btn active">Daily Standard</button>
                <button id="weekly-std" class="mode-btn">Weekly Standard</button>
                <button id="daily-draft" class="mode-btn">Mt Holly Daily</button>
                <button id="weekly-draft" class="mode-btn">Mt Holly Weekly</button>
            </div>
            
            <div class="resources">
                <div class="resource-item" id="gems-btn">
                    <span>üíé</span>
                    <span id="gem-count">0</span>
                </div>
                <div class="resource-item" id="keys-btn">
                    <span>üîë</span>
                    <span id="key-count">0</span>
                </div>
                <div class="resource-item" id="dice-btn">
                    <span>üé≤</span>
                    <span id="dice-count">0</span>
                </div>
            </div>
            
            <button id="new-game-btn">New Game</button>
        </div>
        
        <div class="grid-container">
            <div class="grid" id="game-grid"></div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <div class="modal" id="completion-modal">
        <div class="modal-content">
            <h2>üéâ Congratulations!</h2>
            <p id="completion-message"></p>
            <input type="number" id="days-input" placeholder="How many days did it take?" min="1" style="display:none; margin: 10px; padding: 10px; border-radius: 5px; border: none;">
            <div>
                <button id="copy-result-btn">Copy Result</button>
                <button id="close-modal-btn">Close</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="draft-modal">
        <div class="modal-content">
            <h2>Choose Your Challenge</h2>
            <div class="draft-options" id="draft-options"></div>
        </div>
    </div>

    <script>
        // Game state
        let gameState = {
            mode: 'daily-std',
            grid: [],
            resources: { gems: 0, keys: 0, dice: 0 },
            selectedResource: null,
            completedPath: [],
            isComplete: false,
            exploredCells: new Set(),
            seed: ''
        };

        // Challenge database
        const challenges = [
            // Easy challenges (ranks 1-3)
            { text: "Draft {1:4} {roomtype} rooms", ranks: [1,2,3], columns: [], color: '', difficulty: 'easy', type: 'daily' },
            { text: "Have {1:2} keys at once", ranks: [1,2,3], columns: [], color: '', difficulty: 'easy', type: 'daily' },
            { text: "Have {1:2} gems at once", ranks: [1,2,3], columns: [], color: '', difficulty: 'easy', type: 'daily' },
            { text: "Pet a dog", ranks: [1,2,3], columns: [], color: 'green', difficulty: 'easy', type: 'daily' },
            { text: "Eat {1:3} {foodtype}", ranks: [1,2,3], columns: [], color: 'green', difficulty: 'easy', type: 'daily' },
            { text: "Open {1:3} trunks", ranks: [1,2,3], columns: [], color: '', difficulty: 'easy', type: 'daily' },
            { text: "Dig {1:2} times", ranks: [1,2,3], columns: [], color: 'green', difficulty: 'easy', type: 'daily' },
            { text: "Pull {1:2} levers", ranks: [1,2,3], columns: [], color: 'blue', difficulty: 'easy', type: 'daily' },
            { text: "Draft {common_room}", ranks: [], columns: [], color: '', difficulty: 'easy', type: 'daily' },
            { text: "Draft {rare_room}", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'easy', type: 'daily' },
            
            // Medium challenges (ranks 3-5)
            { text: "Have {3:5} inventory items", ranks: [3,4,5], columns: [], colour: '', difficulty: 'medium', type: 'daily' },
            { text: "Complete dartboard puzzle", ranks: [3,4,5], columns: [], colour: 'orange', difficulty: 'medium', type: 'daily' },
            { text: "Use an upgrade disk", ranks: [3,4,5], columns: [], color: 'blue', difficulty: 'medium', type: 'daily' },
            { text: "Open a safe", ranks: [3,4,5], columns: [], color: 'red', difficulty: 'medium', type: 'daily' },
            { text: "Buy an item from showroom", ranks: [3,4,5], columns: [], color: 'yellow', difficulty: 'medium', type: 'daily' },
            { text: "Use the workshop", ranks: [3,4,5], columns: [], color: 'blue', difficulty: 'medium', type: 'daily' },
            { text: "Observe a constellation", ranks: [3,4,5], columns: [], color: 'green', difficulty: 'medium', type: 'daily' },
            { text: "Ride an elevator", ranks: [3,4,5], columns: [], color: 'blue', difficulty: 'medium', type: 'daily' },
            { text: "Find a microchip", ranks: [3,4,5], columns: [], color: 'blue', difficulty: 'medium', type: 'daily' },
            { text: "Draft both Utility Closet and Garage in one run", ranks: [6,7], columns: [], color: "", difficulty: "hard", type: "multi" },
            
            // Hard challenges (ranks 5-7)
            { text: "Reach the antechamber", ranks: [5,6,7], columns: [], color: '', difficulty: 'hard', type: 'multi' },
            { text: "Reach the basement", ranks: [5,6,7], columns: [], color: '', difficulty: 'hard', type: 'multi' },
            { text: "Unlock blackthorn", ranks: [6,7], columns: [], color: '', difficulty: 'hard', type: 'multi' },
            { text: "Unlock gem mines", ranks: [6,7], columns: [], color: '', difficulty: 'hard', type: 'multi' },
            { text: "Complete parlor puzzle", ranks: [5,6,7], columns: [], color: 'orange', difficulty: 'hard', type: 'daily' },
            { text: "Complete laboratory experiment", ranks: [5,6,7], columns: [], color: 'blue', difficulty: 'hard', type: 'daily' },
            { text: "Use a major key", ranks: [5,6,7], columns: [], color: 'red', difficulty: 'hard', type: 'daily' },
            { text: "Draft architect house", ranks: [6,7], columns: [], color: '', difficulty: 'hard', type: 'multi' },
            { text: "Draft both wing halls", ranks: [6,7], columns: [], color: 'orange', difficulty: 'hard', type: 'multi' },
            { text: "See Alzara vision", ranks: [6,7], columns: [], color: 'red', difficulty: 'hard', type: 'daily' },
            { text: "Look through telescope", ranks: [5,6,7], columns: [], color: 'green', difficulty: 'hard', type: 'daily' },
            { text: "Give {5:10} coins to chapel", ranks: [5,6,7], columns: [], color: '', difficulty: 'hard', type: 'multi' },
            { text: "Unlock West Gate Path permanent add‚Äëon", ranks: [6,7], columns: [], color: "", difficulty: "hard", type: "multi" },
        ];

        const commonRooms = [
            "drawing room", "parlor",
            "dining room",  "pantry", "hallway", "den",
            "guest room", "bedroom"
        ];
        
        const rareRooms = [
            "observatory", "laboratory", "workshop", "vault", "secret passage"
        ];

        const roomTypes = [
            "shop", "garden", "red", "blue", "mechanical", "hallway", "bedroom"

        ];

        const foodTypes = [
            "apple", "turnip", "orange", "banana"

        ];
        

        // Colors for grid squares
        const colors = ['yellow', 'blue', 'green', 'red', 'orange', 'purple'];

        // Seeded random number generator
        class SeededRandom {
            constructor(seed) {
                this.seed = this.hashCode(seed.toString());
            }
            
            hashCode(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32-bit integer
                }
                return Math.abs(hash);
            }
            
            next() {
                this.seed = (this.seed * 9301 + 49297) % 233280;
                return this.seed / 233280;
            }
            
            nextInt(min, max) {
                return Math.floor(this.next() * (max - min + 1)) + min;
            }
            
            shuffle(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(this.next() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }
        }

        // Get today's seed
        function getTodaySeed() {
            const today = new Date();
            return `${today.getFullYear()}-${today.getMonth()}-${today.getDate()}`;
        }

        // Process challenge text with ranges
        function processChallenge(challenge, rng) {
    let text = challenge.text;
    
    // Process number ranges first
    const rangeMatch = text.match(/\{(\d+):(\d+)\}/);
    if (rangeMatch) {
        const min = parseInt(rangeMatch[1]);
        const max = parseInt(rangeMatch[2]);
        const value = rng.nextInt(min, max);
        text = text.replace(rangeMatch[0], value);
    }
    
    // Process room selections
    const commonRoomMatch = text.match(/\{common_room\}/);
    if (commonRoomMatch) {
        const room = commonRooms[rng.nextInt(0, commonRooms.length - 1)];
        text = text.replace(commonRoomMatch[0], room);
    }
    
    const rareRoomMatch = text.match(/\{rare_room\}/);
    if (rareRoomMatch) {
        const room = rareRooms[rng.nextInt(0, rareRooms.length - 1)];
        text = text.replace(rareRoomMatch[0], room);
    }

    const roomTypeMatch= text.match(/\{roomtype\}/);
    if (roomTypeMatch) {
        const room = roomTypes[rng.nextInt(0, roomTypes.length - 1)];
        text = text.replace(roomTypeMatch[0], room);
    }

    const foodTypeMatch= text.match(/\{foodtype\}/);
    if (foodTypeMatch) {
        const room = foodTypes[rng.nextInt(0, foodTypes.length - 1)];
        text = text.replace(foodTypeMatch[0], room);
    }
    
    return { ...challenge, text };
}

        // Generate grid
        function generateGrid() {
            const seed = getTodaySeed();
            gameState.seed = seed;
            const rng = new SeededRandom(seed + gameState.mode);
            
            const grid = [];
            const isDraft = gameState.mode.includes('draft');
            
            // Initialize 5x7 grid
            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 5; col++) {
                    const index = row * 5 + col;
                    let cell = {
                        row, col, index,
                        isLobby: row === 6 && col === 2, // Switch: lobby now at top
                        isGoal: row === 0 && col === 2,  // Switch: goal now at bottom
                        isLocked: false,
                        challenge: null,
                        color: '',
                        hasGem: false,
                        hasKey: false,
                        hasDice: false,
                        isCompleted: false,
                        isExplored: isDraft ? (row === 6 && col === 2) : true // Update for new lobby position
                    };
                    
                    // Don't add challenges to lobby or goal
                    if (!cell.isLobby && !cell.isGoal) {
                        // Add some locked cells, but not adjacent to start (lobby)
                        const isAdjacentToLobby = (
                            (row === 5 && col === 2) || // below lobby
                            (row === 6 && col === 1) || // left of lobby  
                            (row === 6 && col === 3)    // right of lobby
                        );
                        
                        if (!isAdjacentToLobby && rng.next() < 0.15) {
                            cell.isLocked = true;
                        }
                        
                        // Add colors to some cells
                        if (rng.next() < 0.3) {
                            cell.color = colors[rng.nextInt(0, colors.length - 1)];
                        }
                        
                        // Add resources
                        const resourceRoll = rng.next();
                        if (resourceRoll < 0.10) cell.hasGem = true;
                        else if (resourceRoll < 0.25) cell.hasKey = true;
                        else if (resourceRoll < 0.35) cell.hasDice = true;
                        
                        // Add challenges if not draft mode or if explored
                        if (!isDraft || cell.isExplored) {
                            cell.challenge = selectChallenge(row + 1, col + 1, cell.color, rng);
                        }
                    }
                    
                    grid.push(cell);
                }
            }
            
            gameState.grid = grid;
            gameState.exploredCells = isDraft ? new Set([32]) : new Set(grid.map((_, i) => i)); // Update for new lobby position (row 6, col 2 = index 32)
        }

        // Select appropriate challenge for cell
        function selectChallenge(rank, column, color, rng) {
            const isMultiMode = gameState.mode.includes('weekly');
            
            let validChallenges = challenges.filter(c => {
                const rankValid = c.ranks.length === 0 || c.ranks.includes(rank);
                const columnValid = c.columns.length === 0 || c.columns.includes(column);
                const colorValid = !color || !c.color || c.color === color;
                const typeValid = !isMultiMode || c.type === 'multi' || c.type === 'daily';
                
                return rankValid && columnValid && colorValid && typeValid;
            });
            
            if (validChallenges.length === 0) {
                validChallenges = challenges.filter(c => c.type === 'daily');
            }
            
            const challenge = validChallenges[rng.nextInt(0, validChallenges.length - 1)];
            return processChallenge(challenge, rng);
        }

        // Render grid
        function renderGrid() {
            const gridElement = document.getElementById('game-grid');
            gridElement.innerHTML = '';
            
            gameState.grid.forEach((cell, index) => {
                const cellElement = document.createElement('div');
                cellElement.className = 'cell';
                cellElement.dataset.index = index;
                
                if (cell.isLobby) {
                    cellElement.classList.add('lobby');
                    cellElement.innerHTML = '<div>üè∞</div><div style="font-size:8px;">START</div>';
                } else if (cell.isGoal) {
                    cellElement.classList.add('goal');
                    cellElement.innerHTML = '<div>üëë</div><div style="font-size:8px;">GOAL</div>';
                } else if (cell.isLocked) {
                    cellElement.classList.add('locked');
                    cellElement.innerHTML = '<div>üîí</div>';
                } else if (!cell.isExplored && gameState.mode.includes('draft')) {
                    cellElement.innerHTML = '<div class="hidden-challenge">?</div>';
                } else if (cell.challenge) {
                    if (cell.color) cellElement.classList.add(cell.color);
                    if (cell.isCompleted) cellElement.classList.add('completed');
                    
                    cellElement.innerHTML = `<div class="challenge-text">${cell.challenge.text}</div>`;
                }
                
                // Add resource icons
                let resourceIcons = '';
                if (cell.hasGem) resourceIcons += 'üíé';
                if (cell.hasKey) resourceIcons += 'üîë';
                if (cell.hasDice) resourceIcons += 'üé≤';
                if (resourceIcons) {
                    cellElement.innerHTML += `<div class="resource-icon">${resourceIcons}</div>`;
                }
                
                cellElement.addEventListener('click', () => handleCellClick(index));
                gridElement.appendChild(cellElement);
            });
            
            updatePathDisplay();
        }

        // Handle cell click
        function handleCellClick(index) {
            const cell = gameState.grid[index];
            
            if (gameState.selectedResource) {
                handleResourceUse(index);
                return;
            }
            
            // Allow uncompleting completed cells
            if (cell.isCompleted && !cell.isLobby && !cell.isGoal) {
                cell.isCompleted = false;
                renderGrid();
                checkWinCondition();
                return;
            }
            
            // Draft mode exploration
            if (gameState.mode.includes('draft') && !cell.isExplored && !cell.isLobby && !cell.isGoal) {
                const adjacentToExplored = isAdjacentToExplored(index);
                if (adjacentToExplored) {
                    showDraftOptions(index);
                    return;
                }
            }
            
            // Complete challenges
            if ((cell.challenge || cell.isLobby) && !cell.isCompleted && !cell.isLocked) {
                completeCell(index);
                checkWinCondition();
            }
        }

        // Check if cell is adjacent to explored AND completed cell
        function isAdjacentToExplored(index) {
            const cell = gameState.grid[index];
            const adjacents = [
                index - 5, // up
                index + 5, // down
                index - 1, // left
                index + 1  // right
            ].filter(i => {
                if (i < 0 || i >= 35) return false;
                const adjCell = gameState.grid[i];
                if (Math.abs(adjCell.col - cell.col) > 1) return false;
                return gameState.exploredCells.has(i) && (adjCell.isCompleted || adjCell.isLobby);
            });
            
            return adjacents.length > 0;
        }

        // Show draft options
        function showDraftOptions(index) {
            const cell = gameState.grid[index];
            const seed = gameState.seed + index;
            const rng = new SeededRandom(seed);
            
            const options = [];
            for (let i = 0; i < 3; i++) {
                const challenge = selectChallenge(cell.row + 1, cell.col + 1, cell.color, rng);
                options.push(challenge);
            }
            
            const modal = document.getElementById('draft-modal');
            const optionsContainer = document.getElementById('draft-options');
            optionsContainer.innerHTML = '';
            
            options.forEach((option, i) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'draft-option';
                optionElement.textContent = option.text;
                optionElement.addEventListener('click', () => {
                    selectDraftOption(index, option);
                    modal.style.display = 'none';
                });
                optionsContainer.appendChild(optionElement);
            });
            
            modal.style.display = 'flex';
        }

        // Select draft option
        function selectDraftOption(index, challenge) {
            const cell = gameState.grid[index];
            cell.challenge = challenge;
            cell.isExplored = true;
            gameState.exploredCells.add(index);
            renderGrid();
        }

        // Handle resource use
        function handleResourceUse(index) {
            const cell = gameState.grid[index];
            const resource = gameState.selectedResource;
            
            if (resource === 'keys' && cell.isLocked && gameState.resources.keys > 0) {
                cell.isLocked = false;
                gameState.resources.keys--;
                showNotification('üîë Lock removed!');
            } else if (resource === 'dice' && cell.challenge && gameState.resources.dice > 0) {
                const seed = gameState.seed + index + Date.now();
                const rng = new SeededRandom(seed);
                cell.challenge = selectChallenge(cell.row + 1, cell.col + 1, cell.color, rng);
                gameState.resources.dice--;
                showNotification('üé≤ Challenge rerolled!');
            } else if (resource === 'gems' && cell.challenge && gameState.resources.gems > 0) {
                const rangeMatch = cell.challenge.text.match(/\d+/);
                if (rangeMatch && parseInt(rangeMatch[0]) > 1) {
                    const newValue = Math.max(1, parseInt(rangeMatch[0]) - 1);
                    cell.challenge.text = cell.challenge.text.replace(rangeMatch[0], newValue);
                    gameState.resources.gems--;
                    showNotification('üíé Requirement reduced!');
                } else {
                    showNotification('üíé Cannot reduce further!');
                }
            } else {
                showNotification('‚ùå Cannot use that here!');
            }
            
            gameState.selectedResource = null;
            document.querySelectorAll('.resource-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            updateResourceDisplay();
            renderGrid();
        }

        // Complete cell
        function completeCell(index) {
            const cell = gameState.grid[index];
            cell.isCompleted = true;
            
            // Collect resources
            if (cell.hasGem) {
                gameState.resources.gems++;
                cell.hasGem = false;
            }
            if (cell.hasKey) {
                gameState.resources.keys++;
                cell.hasKey = false;
            }
            if (cell.hasDice) {
                gameState.resources.dice++;
                cell.hasDice = false;
            }
            
            updateResourceDisplay();
            renderGrid();
        }

        // Check win condition
        function checkWinCondition() {
            const path = findPath();
            if (path.length > 0) {
                gameState.isComplete = true;
                gameState.completedPath = path;
                showCompletionModal();
            }
            updatePathDisplay();
        }

        // Find path from lobby to goal
        function findPath() {
            const start = gameState.grid.findIndex(cell => cell.isLobby && cell.isCompleted);
            const goal = gameState.grid.findIndex(cell => cell.isGoal);
            
            if (start === -1) return [];
            
            const queue = [[start]];
            const visited = new Set([start]);
            
            while (queue.length > 0) {
                const path = queue.shift();
                const current = path[path.length - 1];
                
                if (current === goal) return path;
                
                const currentCell = gameState.grid[current];
                const adjacents = [
                    current - 5, // up
                    current + 5, // down
                    current - 1, // left
                    current + 1  // right
                ].filter(i => {
                    if (i < 0 || i >= 35) return false;
                    if (visited.has(i)) return false;
                    
                    const adjCell = gameState.grid[i];
                    if (Math.abs(adjCell.col - currentCell.col) > 1) return false;
                    
                    return adjCell.isCompleted || adjCell.isGoal;
                });
                
                adjacents.forEach(adj => {
                    visited.add(adj);
                    queue.push([...path, adj]);
                });
            }
            
            return [];
        }

        // Update path display
        function updatePathDisplay() {
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('path');
            });
            
            if (gameState.completedPath.length > 0) {
                gameState.completedPath.forEach(index => {
                    const cellElement = document.querySelector(`[data-index="${index}"]`);
                    if (cellElement) cellElement.classList.add('path');
                });
            }
        }

        // Show completion modal
        function showCompletionModal() {
            const modal = document.getElementById('completion-modal');
            const message = document.getElementById('completion-message');
            const daysInput = document.getElementById('days-input');
            
            if (gameState.mode.includes('weekly')) {
                message.textContent = 'Path complete! How many days did it take?';
                daysInput.style.display = 'block';
            } else {
                message.textContent = 'Daily challenge completed!';
                daysInput.style.display = 'none';
            }
            
            modal.style.display = 'flex';
        }

        // Copy result to clipboard
        function copyResult() {
            let result = '';
            let days = '';
            
            if (gameState.mode.includes('weekly')) {
                const daysInput = document.getElementById('days-input');
                days = daysInput.value || '1';
                result += `Blue Prince ${gameState.mode} completed in ${days} days!\n\n`;
            } else {
                result += `Blue Prince ${gameState.mode} completed!\n\n`;
            }
            
            // Create emoji grid (flip vertically to match visual)
            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 5; col++) {
                    const index = row * 5 + col;
                    const cell = gameState.grid[index];
                    
                    if (gameState.completedPath.includes(index)) {
                        result += 'üü¢';
                    } else if (cell.isCompleted) {
                        result += '‚ö™';
                    } else {
                        result += '‚¨ú';
                    }
                }
                result += '\n';
            }
            
            navigator.clipboard.writeText(result).then(() => {
                showNotification('üìã Result copied to clipboard!');
            });
        }

        // Show notification
        function showNotification(text) {
            const notification = document.getElementById('notification');
            notification.textContent = text;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Update resource display
        function updateResourceDisplay() {
            document.getElementById('gem-count').textContent = gameState.resources.gems;
            document.getElementById('key-count').textContent = gameState.resources.keys;
            document.getElementById('dice-count').textContent = gameState.resources.dice;
        }

        // Initialize game
        function initGame() {
            gameState.resources = { gems: 0, keys: 0, dice: 0 };
            gameState.selectedResource = null;
            gameState.completedPath = [];
            gameState.isComplete = false;
            gameState.exploredCells = new Set();
            
            generateGrid();
            renderGrid();
            updateResourceDisplay();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Mode selection
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    gameState.mode = e.target.id;
                    initGame();
                });
            });

            // Resource selection
            document.getElementById('gems-btn').addEventListener('click', () => {
                if (gameState.resources.gems > 0) {
                    toggleResourceSelection('gems');
                }
            });

            document.getElementById('keys-btn').addEventListener('click', () => {
                if (gameState.resources.keys > 0) {
                    toggleResourceSelection('keys');
                }
            });

            document.getElementById('dice-btn').addEventListener('click', () => {
                if (gameState.resources.dice > 0) {
                    toggleResourceSelection('dice');
                }
            });

            // New game button
            document.getElementById('new-game-btn').addEventListener('click', initGame);

            // Modal buttons
            document.getElementById('copy-result-btn').addEventListener('click', copyResult);
            
            document.getElementById('close-modal-btn').addEventListener('click', () => {
                document.getElementById('completion-modal').style.display = 'none';
            });

            // Initialize first game
            initGame();
        });

        // Toggle resource selection
        function toggleResourceSelection(resource) {
            document.querySelectorAll('.resource-item').forEach(item => {
                item.classList.remove('selected');
            });

            if (gameState.selectedResource === resource) {
                gameState.selectedResource = null;
            } else {
                gameState.selectedResource = resource;
                document.getElementById(`${resource}-btn`).classList.add('selected');
            }
        }
    </script>
</body>
</html>