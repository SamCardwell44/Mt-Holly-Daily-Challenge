<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
    body {
        font-family: 'Courier New', monospace;
        background: #0a0a0a;
        color: #00C07A;
        margin: 0;
        padding: 20px;
        min-height: 100vh;
        background-image: 
            radial-gradient(circle at 25% 25%, #001100 0%, transparent 50%),
            radial-gradient(circle at 75% 75%, #000011 0%, transparent 50%);
    }
    
    .container {
        max-width: 1000px;
        margin: 0 auto;
        background: #1a1a1a;
        border: 3px solid #00C07A;
        border-radius: 0;
        padding: 30px;
        box-shadow: 
            0 0 20px #00C07A,
            inset 0 0 20px rgba(0, 255, 65, 0.1);
    }
    
    h1 {
        text-align: center;
        color: #00C07A;
        margin-bottom: 30px;
        font-size: 2.5em;
        text-shadow: 0 0 10px #00C07A;
        letter-spacing: 3px;
        text-transform: uppercase;
    }
    
    .game-controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .game-controls .second-row {
        width: 100%;
        justify-content: center;
    }

    @media (max-width: 768px) {
        .game-controls {
            flex-direction: column;
            align-items: center;
        }
        
        .score-display {
            order: 2;
            margin-top: 15px;
        }
        
        .second-row {
            order: 3;
            margin-top: 0 !important;
        }
    }
    
    .mode-select, .resources {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    button {
        background: #122026;
        color: #00C07A;
        border: 2px solid #00C07A;
        padding: 10px 15px;
        border-radius: 0;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
        font-family: 'Courier New', monospace;
        text-transform: uppercase;
        font-size: 12px;
    }
    
    button:hover {
        background: #00C07A;
        color: #000;
        box-shadow: 0 0 10px #00C07A;
    }
    
    button.active {
        background: #00C07A;
        color: #000;
        box-shadow: 0 0 15px #00C07A;
    }
    
    .resources {
        background: rgba(0, 255, 65, 0.1);
        padding: 10px;
        border-radius: 0;
        border: 2px solid #00C07A;
    }
    
    .resource-item {
        display: flex;
        align-items: center;
        gap: 5px;
        margin: 0 10px;
        cursor: pointer;
        padding: 5px;
        border-radius: 0;
        transition: all 0.3s;
        background: #122026;
        border: 2px solid #666;
        font-family: 'Courier New', monospace;
        color: #00C07A;
    }
    
    .resource-item:hover {
        border-color: #00C07A;
        box-shadow: 0 0 5px #00C07A;
    }
    
    .resource-item.selected {
        border-color: #00C07A;
        background: rgba(0, 255, 65, 0.2);
        box-shadow: 0 0 10px #00C07A;
    }
    
    .grid-container {
        display: flex;
        justify-content: center;
        margin: 30px 0;
    }
    
    .grid {
        display: grid;
        grid-template-columns: repeat(5, 80px);
        grid-template-rows: repeat(7, 80px);
        gap: 5px;
        background: #0a0a0a;
        padding: 20px;
        border-radius: 0;
        border: 3px solid #00C07A;
        box-shadow: 0 0 20px #00C07A;
    }
    
    .cell {
        width: 80px;
        height: 80px;
        border: 2px solid #122026;
        border-radius: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        position: relative;
        font-size: 10px;
        text-align: center;
        transition: all 0.3s ease;
        overflow: hidden;
        background: #1a1a1a;
        color: #00C07A;
        font-family: 'Courier New', monospace;
    }
    
    .cell:hover {
        border-color: #00C07A;
        transform: scale(1.05);
        box-shadow: 0 0 8px rgba(0, 255, 65, 0.3);
    }
    
    .cell.lobby {
        background: #003300;
        border: 2px solid  #00C07A;
        box-shadow: 0 0 10px  #00C07A;
        color: #d1d1d1;
    }
    
    .cell.goal {
        background: #d1d1d1;
        border: 2px solid #d1d1d1;
        box-shadow: 0 0 10px #d1d1d1;
        color: #000000;
    }
    
    .cell.completed {
        background: #004400;
        border-color: #00C07A;
    }
    
    .cell.locked {
        background: #330000;
        border-color: #ff4444;
        color: #ff4444;
    }
    
    .cell {
        background: #1a1a1a;
    }
    
    .cell.yellow { 
        border-color: #ffff00; 
        border-width: 3px; 
    }
    .cell.blue { 
        border-color: #0088ff; 
        border-width: 3px; 
    }
    .cell.green { 
        border-color: #00ff00; 
        border-width: 3px; 
    }
    .cell.red { 
        border-color: #ff0000; 
        border-width: 3px; 
    }
    .cell.orange { 
        border-color: #ff8800; 
        border-width: 3px; 
    }
    .cell.purple {
        border-color: #aa00ff; 
        border-width: 3px; 
    }
    
    .cell.path {
        box-shadow: 0 0 20px rgba(0,255,136,0.8);
        animation: pulse 2s infinite;
        background: #006600 !important;
        border: 2px solid #00C07A !important;
    }
    
    @keyframes pulse {
        0%, 100% { box-shadow: 0 0 20px rgba(0,255,136,0.8); }
        50% { box-shadow: 0 0 30px rgba(0,255,136,1); }
    }
    
    .resource-icon {
        position: absolute;
        top: 2px;
        right: 2px;
        font-size: 12px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 2px;
        padding: 1px 2px;
    }
    
    .challenge-text {
        font-size: 9px;
        line-height: 1.1;
        padding: 2px;
        text-shadow: 0 0 3px currentColor;
    }
    
    .hidden-challenge {
        color: #666;
        font-size: 20px;
        text-shadow: 0 0 5px #666;
    }
    
    .notification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #1a1a1a;
        border: 2px solid #00C07A;
        color: #00C07A;
        padding: 15px 30px;
        border-radius: 0;
        z-index: 1000;
        display: none;
        text-align: center;
        font-family: 'Courier New', monospace;
        box-shadow: 0 0 20px #00C07A;
    }
    
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1001;
    }
    
    .modal-content {
        background: #1a1a1a;
        border: 3px solid #00C07A;
        padding: 30px;
        border-radius: 0;
        text-align: center;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 0 30px #00C07A;
        font-family: 'Courier New', monospace;
        color: #00C07A;
    }
    
    .draft-options {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin: 20px 0;
    }
    
    .draft-option {
        background: #122026;
        border: 2px solid #666;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
        border-radius: 0;
        font-family: 'Courier New', monospace;
        color: #00C07A;
    }
    
    .draft-option:hover {
        border-color: #00C07A;
        box-shadow: 0 0 10px #00C07A;
    }

    /* Draft option colors matching cell colors */
    .draft-option.yellow {
        background: #332200;
        border-color: #ffff00;
        color: #ffff77;
    }

    .draft-option.blue {
        background: #001133;
        border-color: #0088ff;
        color: #77ccff;
    }

    .draft-option.green {
        background: #003300;
        border-color: #00ff00;
        color: #77ff77;
    }

    .draft-option.red {
        background: #330000;
        border-color: #ff0000;
        color: #ff7777;
    }

    .draft-option.orange {
        background: #331100;
        border-color: #ff8800;
        color: #ffaa77;
    }

    .draft-option.purple {
        background: #220033;
        border-color: #aa00ff;
        color: #cc77ff;
    }

    .help-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #122026;
        color: #00C07A;
        border: 2px solid #00C07A;
        padding: 10px;
        border-radius: 0;
        cursor: pointer;
        font-size: 20px;
        transition: all 0.3s ease;
        z-index: 100;
    }

    .help-btn:hover {
        background: #00C07A;
        color: #000;
        box-shadow: 0 0 10px #00C07A;
    }

    .email-interface {
        max-width: 800px;
        margin: 20px auto;
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid #00C07A;
        padding: 20px;
        display: flex;
        gap: 20px;
    }

    #email-list {
        flex: 1;
        max-height: 400px;
        overflow-y: auto;
    }

    .email-list-item {
        padding: 10px;
        border: 1px solid #00C07A;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .email-list-item:hover {
        background: rgba(0, 192, 122, 0.1);
    }

    .email-list-item.selected {
        background: rgba(0, 192, 122, 0.2);
    }

    .email-list-item.unread {
        border-left: 4px solid #00C07A;
    }

    .email-list-item.pinned::before {
        content: "📌";
        margin-right: 5px;
    }

    #email-content {
        flex: 2;
        padding: 20px;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid #00C07A;
    }

    #secrets-counter {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        padding: 10px;
        border: 1px solid #00C07A;
    }

    .help-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1002;
    }

    .help-content {
        background: #0a0a0a;
        border: 3px solid #00C07A;
        padding: 30px;
        border-radius: 0;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 0 30px #00C07A;
        font-family: 'Courier New', monospace;
        color: #00C07A;
    }

    .help-header {
        text-align: center;
        border-bottom: 2px solid #00C07A;
        padding-bottom: 15px;
        margin-bottom: 20px;
    }

    .help-title {
        font-size: 1.8em;
        text-transform: uppercase;
        letter-spacing: 2px;
        text-shadow: 0 0 5px #00C07A;
        margin: 0;
    }

    .help-subtitle {
        font-size: 0.9em;
        margin: 5px 0 0 0;
        color: #888;
    }

    .help-section {
        margin: 20px 0;
        border-left: 3px solid #00C07A;
        padding-left: 15px;
    }

    .help-section h3 {
        color: #00C07A;
        text-transform: uppercase;
        font-size: 1.1em;
        margin: 0 0 10px 0;
        text-shadow: 0 0 3px #00C07A;
    }

    .help-section p {
        margin: 8px 0;
        line-height: 1.4;
    }

    .help-modes {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin: 15px 0;
    }

    .help-mode {
        background: #1a1a1a;
        border: 2px solid #666;
        padding: 10px;
        border-radius: 0;
    }

    .help-mode-title {
        color: #00C07A;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .help-resources {
        background: #1a1a1a;
        border: 2px solid #00C07A;
        padding: 15px;
        margin: 15px 0;
    }

    .help-resource {
        display: flex;
        align-items: center;
        margin: 8px 0;
    }

    .help-resource-icon {
        font-size: 1.2em;
        margin-right: 10px;
        width: 25px;
    }

    .help-close {
        position: absolute;
        top: 10px;
        right: 15px;
        background: none;
        border: none;
        color: #00C07A;
        font-size: 24px;
        cursor: pointer;
        font-family: 'Courier New', monospace;
    }

    .help-close:hover {
        color: #fff;
        text-shadow: 0 0 5px #00C07A;
    }

    .help-scoring {
        background: #001100;
        border: 2px solid #00C07A;
        padding: 15px;
        margin: 15px 0;
    }

    @media (max-width: 768px) {
        .help-modes {
            grid-template-columns: 1fr;
        }
        
        .help-content {
            padding: 20px;
            margin: 10px;
        }
    }
</style>
</head>
<body>
    <button class="help-btn" id="help-btn">✉️</button>

<style>
    .help-content {
        background: #0a0a0a;
        border: 3px solid #00C07A;
        padding: 0;
        border-radius: 0;
        max-width: 800px;
        width: 90%;
        max-height: 80vh;
        box-shadow: 0 0 30px #00C07A;
        font-family: 'Courier New', monospace;
        color: #00C07A;
        display: flex;
        overflow: hidden;
    }

    .email-list {
        width: 300px;
        border-right: 3px solid #00C07A;
        overflow-y: auto;
        max-height: 80vh;
        background: #0a0a0a;
        box-shadow: inset 0 0 10px rgba(0, 192, 122, 0.1);
    }

    .email-list-item {
        padding: 15px;
        border-bottom: 2px solid #00C07A;
        cursor: pointer;
        transition: all 0.3s;
        margin: 0;
        border-left: 3px solid transparent;
        position: relative;
    }

    .email-list-item:hover {
        background: rgba(0, 192, 122, 0.1);
        border-left: 3px solid #00C07A;
    }

    .email-list-item.selected {
        background: rgba(0, 192, 122, 0.2);
        border-left: 3px solid #00C07A;
    }

    .email-list-item.pinned {
        background: #001100;
    }

    .email-content {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
        max-height: 80vh;
        background: #0a0a0a;
        border-left: 3px solid #00C07A;
        box-shadow: inset 0 0 15px rgba(0, 192, 122, 0.1);
    }

    .email-header {
        border-bottom: 3px solid #00C07A;
        padding-bottom: 15px;
        margin-bottom: 20px;
        background: rgba(0, 192, 122, 0.05);
        margin: -30px -30px 20px -30px;
        padding: 30px;
    }

    .email-subject {
        font-size: 1.8em;
        text-transform: uppercase;
        letter-spacing: 2px;
        text-shadow: 0 0 5px #00C07A;
        margin: 0;
    }

    .email-meta {
        font-size: 0.9em;
        margin: 5px 0 0 0;
        color: #888;
        border-top: 1px solid rgba(0, 192, 122, 0.3);
        padding-top: 5px;
        margin-top: 10px;
    }

    .email-body {
        padding: 20px;
        line-height: 1.6;
        background: rgba(0, 192, 122, 0.02);
        border: 1px solid rgba(0, 192, 122, 0.1);
    }

    .secrets-counter {
        position: absolute;
        top: 15px;
        left: 15px;
        padding: 5px 10px;
        background: #001100;
        border: 1px solid #00C07A;
        font-size: 0.8em;
        z-index: 1;
    }
</style>

<div class="help-modal" id="help-modal">
    <div class="help-content">
        <button class="help-close" id="help-close">×</button>

        
        <div class="email-list" id="email-list">
            <!-- Email list items will be populated here -->
        </div>

        <div class="email-content" id="email-content">
            <!-- Selected email content will be displayed here -->
        </div>
    </div>
</div>
    <div class="container">
        <h1>🏰 Mt Holly. Daily Challenge</h1>
        
        <div class="game-controls">
            <div class="mode-select">
                <button id="daily-std" class="mode-btn active">Standard Expedition</button>
                <button id="weekly-std" class="mode-btn">Standard Campaign</button>
                <button id="daily-draft" class="mode-btn">Draft Expedition</button>
                <button id="weekly-draft" class="mode-btn">Draft Campaign</button>
            </div>

        <div class="daily-toggle">
            <label>
                <input type="checkbox" id="daily-seed-toggle" checked> Use Daily Seed
            </label>
        </div>
        <div id="manual-seed-container" style="display: none;">
            <label for="manual-seed">Custom Seed:</label>
            <input type="text" id="manual-seed" placeholder="Enter seed...">
            <button id="apply-seed-btn">Apply</button>
        </div>
            <div class="second-row" style="display: flex; gap: 20px; margin-top: 15px; justify-content: center; align-items: center;">
                <div class="resources">
                    <div class="resource-item" id="gems-btn">
                        <span>💎</span>
                        <span id="gem-count">0</span>
                    </div>
                    <div class="resource-item" id="keys-btn">
                        <span>🔑</span>
                        <span id="key-count">0</span>
                    </div>
                    <div class="resource-item" id="dice-btn">
                        <span>🎲</span>
                        <span id="dice-count">0</span>
                    </div>
                </div>
                
                <div class="score-display" style="display: flex; gap: 20px; align-items: center;">
                    <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px;">
                        <span>Score: </span><span id="score-display">0</span>
                    </div>
                    <div id="days-control" style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; display: none;">
                        <label for="days-counter">Days: </label>
                        <input type="number" id="days-counter" value="1" min="1" max="999" style="width: 60px; padding: 5px; border: none; border-radius: 5px; background: #444; color: white;">
                    </div>
                </div>
                
                <button id="new-game-btn">Reset</button>
            </div>
        </div>
        
        <div class="grid-container">
            <div class="grid" id="game-grid"></div>
        </div>
    </div>

    <div style="text-align: center; margin-top: 20px;">
        <button id="share-btn" style="background: #2196F3; padding: 12px 24px; font-size: 16px;">Share Result</button>
    </div>

    <div class="notification" id="notification"></div>
    
    <div class="email-interface" style="display: none;">
        <div id="email-list"></div>
        <div id="email-content"></div>
        <div id="secrets-counter">🔍 0/10 Secrets Found</div>
    </div>
    
    <div class="modal" id="draft-modal">
        <div class="modal-content">
            <h2>Choose Your Challenge</h2>
            <div class="draft-options" id="draft-options"></div>
        </div>
    </div>

    <script>
        
        //Uncomment out when testing complete
        //localStorage.clear();

        // Game state
        let gameState = {
            mode: 'daily-std',
            grid: [],
            resources: { gems: 0, keys: 0, dice: 0 },
            selectedResource: null,
            completedPath: [],
            isComplete: false,
            exploredCells: new Set(),
            seed: '',
            usedChallenges: new Set(),
            stats: {
                completedRuns: 0,
                totalGems: 0,
                totalKeys: 0,
                totalDice: 0,
                highScore: 0
            },
            receivedEmails: [],
            completedPaths: new Set(),
            emailTriggers: {
                pathComplete: false,
                challengeSquaresFilled: 0,
                completedChallenges: new Set(),
                completedTexts: new Set(),
                colorRooms: {},
                patterns: new Set()
            }
        };

            // Email system
        const emailSystem = {
            // Initialize emails in localStorage
            init() {
                let emailData = localStorage.getItem('blueprince_emails');
                
                // If no data exists, create initial structure
                if (!emailData) {
                    emailData = JSON.stringify({
                        emails: [],

                    });
                    localStorage.setItem('blueprince_emails', emailData);
                }
                
                // Always check for initial emails, they should persist
                this.checkAndSendInitialEmails();
                
                // Update the UI immediately
                this.updateEmailList();
            },            // Load emails from localStorage
            getEmails() {
                const data = JSON.parse(localStorage.getItem('blueprince_emails'));
                return data.emails;
            },

            // Save emails to localStorage
            saveEmails(emails) {
                const data = JSON.parse(localStorage.getItem('blueprince_emails'));
                data.emails = emails;
                data.foundSecrets = emails.filter(e => e.secret).length;
                localStorage.setItem('blueprince_emails', JSON.stringify(data));
            },

            // Send a new email
            sendEmail(email) {
                const emails = this.getEmails();
                if (!emails.find(e => e.id === email.id)) {
                    // Create new email object
                    const newEmail = {
                        ...email,
                        date: new Date().toISOString(),
                        read: false,
                        secret: email.secret || false,
                        pinned: email.pinned || false
                    };
                    
                    // Add to emails array
                    emails.push(newEmail);
                    
                    // Sort emails (pinned first, then by date)
                    emails.sort((a, b) => {
                        if (a.pinned && !b.pinned) return -1;
                        if (!a.pinned && b.pinned) return 1;
                        return new Date(b.date) - new Date(a.date);
                    });
                    
                    this.saveEmails(emails);
                    this.updateEmailList();
                    
                    // If it's a new email and not the initial emails, show a notification
                    if (!email.pinned && email.id !== 'drafting-strategy') {
                        showNotification('📧 New email received!');
                    }
                }
            },

            // Mark an email as read
            markAsRead(emailId) {
                const emails = this.getEmails();
                const email = emails.find(e => e.id === emailId);
                if (email && !email.read) {
                    email.read = true;
                    this.saveEmails(emails);
                }
            },

            // Update the email list in the UI
            updateEmailList() {
                const emailList = document.getElementById('email-list');
                const emails = this.getEmails();
                
                emailList.innerHTML = '';
                
                // Sort emails: pinned first, then by date descending
                emails.sort((a, b) => {
                    if (a.pinned && !b.pinned) return -1;
                    if (!a.pinned && b.pinned) return 1;
                    return new Date(b.date) - new Date(a.date);
                });

                emails.forEach(email => {
                    const item = document.createElement('div');
                    item.className = 'email-list-item';
                    if (email.pinned) item.classList.add('pinned');
                    if (!email.read) item.classList.add('unread');
                    
                    item.innerHTML = `
                        <div class="subject">${email.subject}</div>
                        <div class="date">${new Date(email.date).toLocaleDateString()}</div>
                    `;
                    
                    item.addEventListener('click', () => {
                        this.displayEmail(email);
                        document.querySelectorAll('.email-list-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                    });
                    
                    emailList.appendChild(item);
                });

                // Update secrets counter
                const data = JSON.parse(localStorage.getItem('blueprince_emails'));
                document.getElementById('secrets-counter').textContent = 
                    `🔍 ${data.foundSecrets}/${data.totalSecrets} Secrets Found`;
            },

            // Display an email in the content area
            displayEmail(email) {
                const content = document.getElementById('email-content');
                content.innerHTML = `
                    <div class="email-header">
                        <h1 class="email-subject">${email.subject}</h1>
                        <p class="email-meta">Date: ${new Date(email.date).toLocaleDateString()}</p>
                    </div>
                    <div class="email-body">${email.content}</div>
                `;
                this.markAsRead(email.id);
                this.updateEmailList();
            },

            // Check for and send initial emails
            checkAndSendInitialEmails() {
                // Send How to Play email (always pinned)
                this.sendEmail({
                    id: 'how-to-play',
                    subject: 'How to Play - Mt Holly Daily Challenge',
                    content: `
                        <div class="email-section">
                            <h3>Game Modes</h3>
                            <div class="email-modes">
                                <div class="email-mode">
                                    <div class="email-mode-title">EXPEDITION</div>
                                    <p>Single-day completion. Complete the path in one session.</p>
                                </div>
                                <div class="email-mode">
                                    <div class="email-mode-title">CAMPAIGN</div>
                                    <p>Multi-day completion. Score penalty for additional days.</p>
                                </div>
                            </div>
                            
                            <div class="email-modes">
                                <div class="email-mode">
                                    <div class="email-mode-title">STANDARD</div>
                                    <p>All challenges visible from start. Plan your route carefully.</p>
                                </div>
                                <div class="email-mode">
                                    <div class="email-mode-title">DRAFT</div>
                                    <p>Draft challenges as you explore. Adjacent completed rooms only.</p>
                                </div>
                            </div>
                        </div>

                        <div class="email-section">
                            <h3>Resources</h3>
                            <span>To use a resource, click its icon then click on the square you want to use it on.</span>
                            <div class="email-resources">
                                <div class="email-resource">
                                    <span class="email-resource-icon">🔑</span>
                                    <span><strong>KEYS:</strong> Unlock locked squares. Essential for blocked paths.</span>
                                </div>
                                <div class="email-resource">
                                    <span class="email-resource-icon">💎</span>
                                    <span><strong>GEMS:</strong> Reduce number requirements by 30% (minimum 1). Use on high-value challenges.</span>
                                </div>
                                <div class="email-resource">
                                    <span class="email-resource-icon">🎲</span>
                                    <span><strong>DICE:</strong> Reroll challenge. Select color to influence new challenge type.</span>
                                </div>
                            </div>
                        </div>

                        <div class="email-section">
                            <h3>Objective</h3>
                            <p>Create a path from the lobby to the antechamber while maximizing your score.</p>
                            
                            <div class="email-scoring">
                                <h3>Scoring System</h3>
                                <p><strong>Base Score:</strong> +1 point per completed room</p>
                                <p><strong>Path Bonus:</strong> +10 points for connecting the lobby and the antechamber</p>
                                <p><strong>Campaign Mode Penalty:</strong> -1 point per day beyond the first</p>
                                <p><strong>Final Score = Completed Rooms + Path Bonus - Day Penalty</strong></p>
                            </div>
                        </div>`,
                    pinned: true
                });

                // Send Drafting Strategy email if it's the first time
                if (!this.getEmails().find(e => e.id === 'drafting-strategy')) {
                    this.sendEmail({
                        id: 'drafting-strategy',
                        subject: 'Drafting Strategy Vol. 6 - DRAFT FOR REVIEW',
                        content: `
                        <div class="email-section">
                            <h3>Draft Strategy Notes</h3>
                            <p>• Use gems to make challenges easier. It will always go down by at least 1, so you can make some challenges really easy.</p>
                            <p>• Use dice to reroll challenges you cannot complete</p>
                            <p>• Color selection with dice can target specific challenge types</p>
                            <p>• Since campaign mode deducts days taken, sometimes speed can be better than perfection</p>

                            <h3>Color Strategies</h3>
                            <p>Each color has its own strengths. Here's a quick guide:</p>
                            <ul style="list-style: none; padding-left: 0;">
                                <li>🟨 <strong>Yellow (Shop)</strong> - Shopping and gold</li>
                                <li>🟦 <strong>Blue (Tech)</strong> - Blue rooms and mechanical</li>
                                <li>🟩 <strong>Green (Nature)</strong> - Gems and gardens</li>
                                <li>🟥 <strong>Red (Action)</strong> - Red rooms and penalties</li>
                                <li>🟧 <strong>Orange (Utility)</strong> - Keys and pathways</li>
                                <li>🟪 <strong>Purple (Mystery)</strong> - Steps and bedrooms</li>
                            </ul>
                        </div>

                        <div class="email-section">
                            <h3>Path Planning</h3>
                            <p>When drafting, consider these factors:</p>
                            <p>1. Resource availability - Can you get keys/gems early?</p>
                            <p>2. Challenge difficulty - Harder challenges near the start give more time</p>
                            <p>3. Color synergy - Some challenges work better together</p>
                        </div>`,
                        secret: true
                    });
                }
            }
        };

        

        // Save game state to local storage
        function saveGameState() {
            const saveState = {
                mode: gameState.mode,
                grid: gameState.grid.map(cell => ({
                    ...cell,
                    // Convert Sets to arrays for JSON serialization
                    exploredCells: Array.from(gameState.exploredCells),
                    usedChallenges: Array.from(gameState.usedChallenges)
                })),
                resources: gameState.resources,
                completedPath: gameState.completedPath,
                isComplete: gameState.isComplete,
                seed: gameState.seed,
                receivedEmails: gameState.receivedEmails,
                completedPaths: Array.from(gameState.completedPaths),
                emailTriggers: {
                    ...gameState.emailTriggers,
                    completedChallenges: Array.from(gameState.emailTriggers.completedChallenges),
                    completedTexts: Array.from(gameState.emailTriggers.completedTexts),
                    patterns: Array.from(gameState.emailTriggers.patterns)
                }
            };
            const key = `blueprince_${gameState.mode}_${gameState.seed}`;
            localStorage.setItem(key, JSON.stringify(saveState));
        }

        // Load game state from local storage
        function loadGameState(mode, seed) {
            const key = `blueprince_${mode}_${seed}`;
            const savedState = localStorage.getItem(key);
            
            if (savedState) {
                const parsed = JSON.parse(savedState);
                gameState.mode = parsed.mode;
                gameState.grid = parsed.grid;
                gameState.resources = parsed.resources;
                gameState.completedPath = parsed.completedPath;
                gameState.isComplete = parsed.isComplete;
                gameState.seed = parsed.seed;
                
                // Reconstruct Sets from arrays
                gameState.exploredCells = new Set(parsed.grid[0].exploredCells);
                gameState.usedChallenges = new Set(parsed.grid[0].usedChallenges);
                
                // Load email state
                gameState.receivedEmails = parsed.receivedEmails || [];
                gameState.completedPaths = new Set(parsed.completedPaths || []);
                
                // Load email triggers
                if (parsed.emailTriggers) {
                    gameState.emailTriggers = {
                        ...parsed.emailTriggers,
                        completedChallenges: new Set(parsed.emailTriggers.completedChallenges || []),
                        completedTexts: new Set(parsed.emailTriggers.completedTexts || []),
                        patterns: new Set(parsed.emailTriggers.patterns || [])
                    };
                }
                
                return true;
            }
            return false;
        }

        // Check for email triggers
        function checkEmailTriggers() {
            // Count challenge squares filled
            const filledSquares = gameState.grid.filter(cell => cell.isCompleted && !cell.isLobby && !cell.isGoal).length;
            
            // All challenge squares filled email
            if (filledSquares >= 33 && !gameState.emailTriggers.challengeSquaresFilled) {
                emailSystem.sendEmail({
                    id: 'all-squares-filled',
                    subject: '🏆 A full house!',
                    content: `
                    <div class="email-section">
                        <p>Fascinating development!</p>
                        <p>Our sensors indicate you've managed to map every single room in your current layout. This is exactly the kind of thorough exploration data we need!</p>
                        <p>The estate's architecture has always been... fluid, shall we say? But having a complete snapshot like this is invaluable for our research.</p>
                        <p>Do keep exploring different configurations when you can.</p>
                        <p>- Randolph</p>
                    </div>`
                });
                gameState.emailTriggers.challengeSquaresFilled = true;
            }

            // Count rooms of each color
            const colorCounts = {};
            gameState.grid.forEach(cell => {
                if (cell.color) {
                    colorCounts[cell.color] = (colorCounts[cell.color] || 0) + 1;
                }
            });

            // Check for color-based achievements
            Object.entries(colorCounts).forEach(([color, count]) => {
                if (count >= 4 && !gameState.emailTriggers.colorRooms[color]) {
                    emailSystem.sendEmail({
                        id: `${color}-rooms-5`,
                        subject: `🎨 Colourful ideas`,
                        content: `
                        <div class="email-section">
                            <p>I saw you had a lot of colour rooms in your draft, that's great for our data.</p>
                            <p>In some ways, the colours remind me of the Mora Jai puzzles Herbert loved so much.</p>
                            <p>Maybe that's why he insisted we include the coloured squares in this program...</p>
                            <p>Keep experimenting!</p>
                            <p>- Randolph</p>
                        </div>`
                    });
                    gameState.emailTriggers.colorRooms[color] = true;
                }
            });

            // Check for specific challenge text completions
            gameState.grid.forEach(cell => {
                if (cell.isCompleted && cell.challenge && cell.challenge.text) {
                    // Check for specific challenge texts
                    if (cell.challenge.text.toLowerCase().includes('mail room') && 
                        !gameState.emailTriggers.completedTexts.has('mail-room')) {
                        emailSystem.sendEmail({
                            id: 'mail-room-discovered',
                            subject: "📬 You've got mail",
                            content: `
                            <div class="email-section">
                                <h3>We saw you completed a mail room challenge.</h3>
                                <p>That's the primary way we can communicate with anyone at Mt. Holly</p>
                                <p>Of course now we have you set up on here, so we can speak to you at any time! It's much easier.</p>
                                <p>- Randolph</p>
                            </div>`
                        });
                        gameState.emailTriggers.completedTexts.add('mail-room');
                    }
                }
            });

            //Check for the same colour in all 4 corners
            const corners = [
                { row: 0, col: 0 },
                { row: 0, col: 4 },
                { row: 4, col: 0 },
                { row: 4, col: 4 }
            ];
            const cornerColors = corners.map(corner => {
                const index = corner.row * 5 + corner.col;
                return gameState.grid[index] ? gameState.grid[index].color : null;
            });
            const uniqueColors = new Set(cornerColors);

            //Not working yet, but will be used to trigger an email when all corners are the same colour
            if (uniqueColors.size === 1 && cornerColors[0] && !gameState.emailTriggers.patterns.has('corner-color')) {
                emailSystem.sendEmail({
                    id: 'corner-color',
                    subject: 'Mora Jai',
                    content: `
                    <div class="email-section">
                        <h3>I happen to know that Herbert was a big fan of the Mora Jai puzzle box.</h3>
                        <p>He would often show off his collection to us here at SYNKA, and find ways to weave them into the mysteries of Mt Holly.</p>
                        <p>When you made all the corners of your grid the same colour, it triggered something in our code. I guess Herbert snuck it in there.</p>
                        <p>Anyway, the console put out this message:</p>
                        <p>00101011 00110010 00100000 01000100 01001111 01001111 01010010 01011010 01000100 01010001 01000110 01001000 <p>
                        <p>- Randolph</p>
                    </div>`
                });
                gameState.emailTriggers.patterns.add('corner-color');
            }

            // Check for patterns (e.g., completed squares in a specific shape)
            const checkPattern = (name, pattern) => {
                if (!gameState.emailTriggers.patterns.has(name)) {
                    let found = true;
                    pattern.forEach(([row, col]) => {
                        const index = row * 5 + col;
                        if (!gameState.grid[index] || !gameState.grid[index].isCompleted) {
                            found = false;
                        }
                    });
                    if (found) {
                        emailSystem.sendEmail({
                            id: `pattern-${name}`,
                            subject: `🎯 Pattern Discovered: ${name}`,
                            content: `
                            <div class="email-section">
                                <h3>Hidden Pattern Found</h3>
                                <p>You've discovered a secret pattern in the estate's layout!</p>
                                <p>Keep exploring to find more patterns.</p>
                            </div>`
                        });
                        gameState.emailTriggers.patterns.add(name);
                    }
                }
            };

            // Example patterns to check
            //checkPattern('cross', [[2,2], [1,2], [3,2], [2,1], [2,3]]);
            //checkPattern('square', [[1,1], [1,2], [2,1], [2,2]]);

            //Check for beeline to end using pattern (only middle row filled)
                        

            //Loop pattern round edges email
            
            //Draft mode path completed
            

            //Campaign mode 10 days spent
            


            //5 gems at once
            if (gameState.resources.gems >= 5 && !gameState.emailTriggers.patterns.has('five-gems')) {
                emailSystem.sendEmail({
                    id: 'five-gems',
                    subject: '💎 Crown of gems',
                    content: `
                    <div class="email-section">
                        <p>We've just received a signal that you've gathered five gems at once. Extraordinary.</p>
                        <p>Gathering them in such numbers suggests you’re either very lucky or the estate is beginning to recognize you.</p>
                        <p>Herbert always disappproved of using them to make challenges easier. I could never complete a path without them. </p>
                        <p>I miss our fireside chats about this app, he would have loved to have seen it completed.</p>
                        <p>- Randolph</p>
                        </div>`
                });
                gameState.emailTriggers.patterns.add('five-gems');
            }

            //5 dice at once email
            if (gameState.resources.dice >= 5 && !gameState.emailTriggers.patterns.has('five-dice')) {
                emailSystem.sendEmail({
                    id: 'five-dice',
                    subject: '🎲 High roller',
                    content: `
                    <div class="email-section">
                        <h3>Die collector</h3>
                        <p>Five dice at once? Not bad.</p>
                        <p>In the old labs, Herbert would say the dice were “the estate’s way of choosing its next move.” They appeared randomly, but always with intention.</p>
                        <p>Now that you've gathered five, don’t squander them!</p>
                        <p>We'll keep monitoring your trajectory with interest.</p>
                        <p>- Randolph</p>
                    </div>`
                });
                gameState.emailTriggers.patterns.add('five-dice');
            }
            
            //Custom seed used (not the daily seed)
           

    }

        let useRandomSeed = false;
        let randomSeed = Math.random().toString(36).substring(7);

        // Challenge database
        const challenges = [
            // Easy challenges Daily
            { id: 'draft_purple', text: "Draft {2:4} purple rooms", ranks: [3,4,5], columns: [], color: 'purple', difficulty: 'easy', type: 'none' },
            { id: 'draft_yellow', text: "Draft {2:4} shop rooms", ranks: [3,4,5], columns: [], color: 'yellow', difficulty: 'easy', type: 'none' },
            { id: 'draft_blue', text: "Draft {4:8} blue rooms", ranks: [1,2,3,4,5], columns: [], color: 'blue', difficulty: 'easy', type: 'none' },
            { id: 'draft_red', text: "Draft {2:4} red rooms", ranks: [1,2,3,4,5], columns: [], color: 'red', difficulty: 'easy', type: 'none' },
            { id: 'draft_green', text: "Draft {2:4} green rooms", ranks: [1,2,3,4,5], columns: [], color: 'green', difficulty: 'easy', type: 'none' },
            { id: 'keys_at_once_1', text: "Have {3:6} standard keys at once", ranks: [1,2,3,4], columns: [], color: 'orange', difficulty: 'easy', type: 'daily' },
            { id: 'gems_at_once_1', text: "Have {3:6} gems at once", ranks: [1,2,3,4], columns: [], color: 'green', difficulty: 'easy', type: 'daily' },
            { id: 'coins_at_once_1', text: "Have {10:20} coins at once", ranks: [1,2,3,4], columns: [], color: 'yellow', difficulty: 'easy', type: 'daily' },
            { id: 'eat_food_1', text: "Eat {1:3} {foodtype}", ranks: [], columns: [], color: '', difficulty: 'easy', type: 'daily' },
            { id: 'open_trunks_1', text: "Open {1:2} trunks", ranks: [2,3,4,5,6,7], columns: [], color: '', difficulty: 'easy', type: 'daily' },
            { id: 'dig_times_1', text: "Dig {1:2} times", ranks: [1,2,3], columns: [], color: 'green', difficulty: 'easy', type: 'daily' },
            { id: 'draft_common_1', text: "Draft {common_room}", ranks: [1,2,3,4,5], columns: [], color: '', difficulty: 'easy', type: 'none' },
            { id: 'draft_common_2', text: "Draft {common_room}", ranks: [1,2,3,4,5], columns: [], color: '', difficulty: 'easy', type: 'none' },
            { id: 'draft_common_3', text: "Draft {common_room}", ranks: [1,2,3,4,5], columns: [], color: '', difficulty: 'easy', type: 'none' },
            { id: 'draft_common_4', text: "Draft {common_room}", ranks: [1,2,3,4,5], columns: [], color: '', difficulty: 'easy', type: 'none' },
            { id: 'draft_rare_1', text: "Draft {rare_room}", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'easy', type: 'none' },
            { id: 'draft_rare_2', text: "Draft {rare_room}", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'easy', type: 'none' },
            { id: 'draft_rare_3', text: "Draft {rare_room}", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'easy', type: 'none' },
            { id: 'draft_rare_4', text: "Draft {rare_room}", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'easy', type: 'none' },
            { id: 'inventory_items_1', text: "Have {3:5} inventory items", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'daily' },
            { id: 'use_terminal_1', text: "Use a terminal", ranks: [1,2,3,4,5,6,7], columns: [], color: 'blue', difficulty: 'easy', type: 'none' },
            { id: 'buy_shop_1', text: "Buy something from a shop room", ranks: [], columns: [], color: 'yellow', difficulty: 'easy', type: 'none' },
            { id: 'unlock_doors', text: "Unlock {2:4} locked doors", ranks: [], columns: [], color: 'orange', difficulty: 'easy', type: 'none' },
            { id: 'chain_locked', text: "Open {2:3} locked doors in a  row", ranks: [3,4,5,6,7], columns: [], color: 'orange', difficulty: 'easy', type: 'none' },
            { id: 'chain_gems', text: "Draft {2:3} rooms with a gem cost in a row", ranks: [], columns: [], color: 'green', difficulty: 'easy', type: 'none' },
            { id: 'spot_drawing', text: "Find a drawing of a {drawings}", ranks: [], columns: [], color: 'orange', difficulty: 'easy', type: 'none' },
            { id: 'check_time', text: "Wait until {1:4}pm", ranks: [5,6,7], columns: [1,5], color: 'red', difficulty: 'easy', type: 'none' },
            { id: 'windows', text: "Look out windows in {3:5} different rooms", ranks: [], columns: [1,5], color: 'orange', difficulty: 'easy', type: 'none' },
            { id: 'toss_coin', text: "Toss a coin in the fountain", ranks: [1,2,3,4,5], columns: [], color: 'yellow', difficulty: 'easy', type: 'none' },
            { id: 'fill_row_1', text: "Fill row  {1:3} of the estate with rooms all the way across", ranks: [1,2,3], columns: [], color: '', difficulty: 'easy', type: 'none' },
            { id: 'fill_row_2', text: "Fill row  {4:7} of the estate with rooms all the way across", ranks: [4,5,6,7], columns: [], color: '', difficulty: 'easy', type: 'none' },
            { id: 'fill_column', text: "Fill column {1:5} of the estate with rooms all the way up", ranks: [4,5,6,7], columns: [], color: '', difficulty: 'easy', type: 'none' },
                                             
            // Medium challenges Daily
            { id: 'parlor_puzzle_1', text: "Complete parlor puzzle", ranks: [1,2,3,4,5,6,7], columns: [], color: 'blue', difficulty: 'medium', type: 'daily' },
            { id: 'dartboard_puzzle_1', text: "Complete dartboard puzzle", ranks: [1,2,3,4,5,6,7], columns: [], color: 'blue', difficulty: 'medium', type: 'daily' },
            { id: 'upgrade_disk_1', text: "Use an upgrade disk", ranks: [3,4,5,6,7], columns: [], color: 'blue', difficulty: 'medium', type: 'none' },
            { id: 'open_safe_1', text: "Open a safe", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'none' },
            { id: 'pet_dog_1', text: "Pet a dog {1:6} times", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'none' },
            { id: 'craft_item_1', text: "Craft an item", ranks: [3,4,5,6,7], columns: [], color: 'blue', difficulty: 'medium', type: 'none' },
            { id: 'observe_constellation_1', text: "Observe a constellation", ranks: [3,4,5], columns: [], color: 'blue', difficulty: 'medium', type: 'none' },
            { id: 'draft_both_common_1', text: "Draft both {common_room} and {common_room} at the same time", ranks: [6,7], columns: [], color: "", difficulty: "medium", type: "none" },
            { id: 'special_key_1', text: "Use a special (non-standard) key", ranks: [], columns: [], color: 'orange', difficulty: 'medium', type: 'none' },
            { id: 'lab_experiment_1', text: "Trigger a laboratory experiment", ranks: [3,4,5,6,7], columns: [], color: 'blue', difficulty: 'hard', type: 'none' },
            { id: 'read_books_1', text: "Read {2:4} different books", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'none' },
            { id: 'find_photos_1', text: "Find {2:4} different photos", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'none' },
            { id: 'find_memos_1', text: "Find {2:4} different memos", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'none' },
            { id: 'end_in_roomtype_1', text: "End the day in a {roomtype} room", ranks: [3,4,5,6,7], columns: [1,5], color: '', difficulty: 'medium', type: 'none' },
            { id: 'reroll_choices_1', text: "Reroll room choices {2:4} times", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'none' },
            { id: 'ivory_dice_1', text: "Have {2:4} ivory dice at once", ranks: [], columns: [], color: '', difficulty: 'medium', type: 'daily' },
            { id: 'over_60_steps_1', text: "Have over 60 steps", ranks: [3,4,5,6,7], columns: [], color: 'purple', difficulty: 'medium', type: 'daily' },
            { id: 'end_with_steps_1', text: "End the day with {20:40}+ steps", ranks: [3,4,5,6,7], columns: [], color: 'purple', difficulty: 'medium', type: 'daily' },
            { id: 'draft_dead_ends_1', text: "Draft {2:5} dead ends", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'none' },
            { id: 'draft_lavatory_1', text: "Draft the lavatory", ranks: [1,2,3,4,5,6,7], columns: [], color: 'red', difficulty: 'medium', type: 'none' },
            { id: 'draft_furnace_1', text: "Draft the furnace", ranks: [1,2,3,4,5,6,7], columns: [], color: 'red', difficulty: 'medium', type: 'none' },
            { id: 'find_item_1', text: "Find a {item}", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'none' },
            { id: 'find_item_2', text: "Find a {item}", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'none' },
            { id: 'find_item_3', text: "Find a {item}", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'none' },
            { id: 'find_item_4', text: "Find a {item}", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'none' },
            { id: 'pull_levers_1', text: "Pull {1:2} levers", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'none' },
            { id: 'buy_multi_shop', text: "Buy {2:5} things from shop rooms", ranks: [3,4,5,6,7], columns: [], color: 'yellow', difficulty: 'medium', type: 'none' },
            { id: 'draft_double_purple', text: "Draft 2 purple rooms connected to each other", ranks: [], columns: [], color: 'purple', difficulty: 'medium', type: 'none' },
            { id: 'draft_double_orange', text: "Draft 2 hallway rooms connected to each other", ranks: [], columns: [], color: 'orange', difficulty: 'medium', type: 'none' },
            { id: 'gem_flower', text: "Collect a gem from a flower", ranks: [5,6,7], columns: [1,5], color: 'green', difficulty: 'medium', type: 'none' },
            { id: 'draft_mechanical', text: "Draft {2:3} mechanical rooms (rooms with cog icons)", ranks: [3,4,5,6,7], columns: [], color: 'blue', difficulty: 'medium', type: 'none' },
            { id: 'straight_horizontal', text: "Have a straight, unblocked horizontal path across any row of the estate", ranks: [], columns: [], color: 'orange', difficulty: 'medium', type: 'none' },
            { id: 'blocked_doors', text: "Draft a room with {2:3} of its doors blocked", ranks: [2,3,4,5,6,7], columns: [], color: 'orange', difficulty: 'medium', type: 'none' },
            { id: 'multicolour', text: "Have 1 room of each colour in your estate: Red, Yellow, Green, Blue, Purple, Orange", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'none' },
            { id: 'tap', text: "Turn on a tap", ranks: [], columns: [4,5,6,7], color: 'green', difficulty: 'medium', type: 'none' },
            { id: 'bananas_kitchen', text: "Purchase 5 bananas from the kitchen", ranks: [3,4,5,6,7], columns: [], color: 'yellow', difficulty: 'medium', type: 'none' },
            { id: 'living_animal', text: "Find a living animal in the house.", ranks: [4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'none' },
            { id: 'security', text: "Change keycard security settings.", ranks: [2,3,4,5], columns: [], color: '', difficulty: 'medium', type: 'none' },
            { id: 'globe_spin', text: "Spin a globe.", ranks: [3,4,5,6], columns: [], color: '', difficulty: 'medium', type: 'none' },
            { id: 'food_types', text: "Eat {2:3} different types of food.", ranks: [1,2,3,4,5,6], columns: [], color: '', difficulty: 'medium', type: 'none' },
            { id: 'donut', text: "Draft a donut. (An empty square surrounded by rooms)", ranks: [1,2,3,4,5], columns: [1,5], color: '', difficulty: 'medium', type: 'none' },
            { id: 'reroll_multi', text: "Reroll the same draw {2:3} time", ranks: [3,4,5], columns: [1,5], color: '', difficulty: 'medium', type: 'none' },
            { id: 'car_unlock', text: "Unlock the trunk of a car.", ranks: [], columns: [1,2], color: 'yellow', difficulty: 'medium', type: 'none' },
            { id: 'red_letter_1', text: "Read {1:2} red letters", ranks: [], columns: [], color: 'red', difficulty: 'medium', type: 'none' },
            { id: 'security_doors', text: "Bypass {1:2} security doors", ranks: [], columns: [], color: '', difficulty: 'medium', type: 'none' },
            
            // Hard challenges Daily
            { id: 'enter_antechamber_1', text: "Enter the antechamber", ranks: [5,6,7], columns: [], color: '', difficulty: 'hard', type: 'none'},
            { id: 'rotate_room_1', text: "Rotate a room", ranks: [5,6,7], columns: [], color: '', difficulty: 'hard', type: 'none' },
            { id: 'lab_experiment_multi_1', text: "Trigger a laboratory experiment {2:5} times", ranks: [5,6,7], columns: [], color: 'blue', difficulty: 'hard', type: 'none'},
            { id: 'both_wing_halls_1', text: "Have both east and west wing halls at once", ranks: [5,6,7], columns: [1,5], color: 'orange', difficulty: 'hard', type: 'none' },
            { id: 'speak_alzara_1', text: "Speak with Alzara", ranks: [6,7], columns: [], color: '', difficulty: 'hard', type: 'none' },
            { id: 'coins_chapel_1', text: "Give {3:10} coins to chapel", ranks: [5,6,7], columns: [], color: '', difficulty: 'hard', type: 'none' },
            { id: 'rare_next_common_1', text: "Draft {rare_room} connected to {common_room}", ranks: [5,6,7], columns: [], color: '', difficulty: 'hard', type: 'none' },
            { id: 'buried_treasure_1', text: "Find buried treasure", ranks: [5,6,7], columns: [1,5], color: '', difficulty: 'hard', type: 'none' },
            { id: 'allowance_token_1', text: "Find an allowance token", ranks: [5,6,7], columns: [1,5], color: '', difficulty: 'hard', type: 'none' },
            { id: 'end_rare_room_1', text: "End the day in a {rare_room}", ranks: [5,6,7], columns: [1,5], color: '', difficulty: 'hard', type: 'none' },
            { id: 'open_garage_1', text: "Open the garage", ranks: [5,6,7], columns: [1], color: '', difficulty: 'hard', type: 'none' },
            { id: 'light_dark_room_1', text: "Turn on the lights in the darkroom", ranks: [2,3,4,5,6,7], columns: [], color: 'red', difficulty: 'hard', type: 'none' },
            { id: 'power_room', text: "Provide power to {1:3} rooms", ranks: [4,5,6,7], columns: [], color: 'blue', difficulty: 'hard', type: 'none' },
            { id: 'straight_vertical', text: "Have a straight, unblocked vertical path across a whole column of the estate", ranks: [3,4,5,6,7], columns: [], color: 'orange', difficulty: 'hard', type: 'none' },
            { id: 'buyout_commissary', text: "Buyout the commissary", ranks: [], columns: [5,6,7], color: 'yellow', difficulty: 'hard', type: 'none' },
            { id: 'antechamber_passthrough', text: "Walk in one door of the antechamber and out another.", ranks: [7], columns: [], color: '', difficulty: 'hard', type: 'none' },
            { id: 'gym_steps', text: "Lose at least {4:10} steps in the gymnasium", ranks: [3,4,5,6], columns: [], color: 'red', difficulty: 'hard', type: 'none' },
            { id: 'fail_parlor', text: "Fail the parlor puzzle", ranks: [1,2,3,4,5], columns: [], color: 'red', difficulty: 'hard', type: 'none' },
            { id: 'weight_steps', text: "Lose at least {10:20} steps in the weight room", ranks: [5,6,7], columns: [], color: 'red', difficulty: 'hard', type: 'none' },
            { id: 'lockpick', text: "Pick {1:2} locks", ranks: [3,4,5,6,7], columns: [], color: 'orange', difficulty: 'hard', type: 'none' },
            { id: 'corners', text: "Draft a room in all 4 corners of the estate", ranks: [], columns: [], color: '', difficulty: 'hard', type: 'none' },
            { id: 'multi_shop', text: "Buy something from {2:4} different shops", ranks: [2,3,4,5,6,7], columns: [], color: 'yellow', difficulty: 'hard', type: 'none' },
            { id: 'dining_bonus', text: "Gain the bonus steps from the dining room meal.", ranks: [4,5,6,7], columns: [], color: 'orange', difficulty: 'hard', type: 'none' },
            
            
            //Easy challenges multi
            { id: 'unlock_gem_mines_1', text: "Unlock gem mines", ranks: [3,4,5,6], columns: [], color: '', difficulty: 'easy', type: 'multi' },
            { id: 'freeze_accounts_1', text: "Freeze your accounts", ranks: [3,4,5,6], columns: [], color: 'blue', difficulty: 'easy', type: 'multi' },
            { id: 'draft_chess_pieces_1', text: "Draft 1 of every chess piece", ranks: [4,5,6,7], columns: [1,5], color: '', difficulty: 'easy', type: 'multi' },
            { id: 'great_hall_doors_1', text: "Open all the doors in the great hall", ranks: [4,5,6,7], columns: [], color: 'orange', difficulty: 'easy', type: 'multi' },
            { id: 'adjust_rarity_1', text: "Adjust a room's rarity", ranks: [4,5,6,7], columns: [], color: '', difficulty: 'easy', type: 'multi' },
            { id: 'over_100_steps_1', text: "Have over 100 steps", ranks: [4,5,6,7], columns: [], color: 'purple', difficulty: 'easy', type: 'multi' },
            { id: 'parlor_puzzles_multi_1', text: "Complete {2:5} parlor puzzles", ranks: [2,3,4,5,6,7], columns: [], color: '', difficulty: 'easy', type: 'multi' },
            { id: 'dartboard_puzzles_multi_1', text: "Complete {2:5} dartboard puzzles", ranks: [2,3,4,5,6,7], columns: [], color: '', difficulty: 'easy', type: 'multi' },
            { id: 'same_room_twice_1', text: "Have 2 of the same room at once", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'easy', type: 'multi' },
            { id: 'two_items_once_1', text: "Have {item} and {item} at the same time", ranks: [2,3,4,5,6,7], columns: [], color: '', difficulty: 'easy', type: 'multi' },
            { id: 'keys_at_once_2', text: "Have {8:20} standard keys at once", ranks: [], columns: [], color: 'orange', difficulty: 'easy', type: 'multi' },
            { id: 'gems_at_once_2', text: "Have {10:20} gems at once", ranks: [], columns: [], color: 'green', difficulty: 'easy', type: 'multi' },
            { id: 'coins_at_once_2', text: "Have  {50:120} coins at once", ranks: [], columns: [], color: 'yellow', difficulty: 'easy', type: 'multi' },
            { id: 'ivory_dice_2', text: "Have {4:8} ivory dice at once", ranks: [], columns: [], color: '', difficulty: 'easy', type: 'multi' },
            { id: 'eat_food_2', text: "Eat {5:10} {foodtype}", ranks: [], columns: [], color: '', difficulty: 'easy', type: 'multi' },
            { id: 'open_trunks_2', text: "Open {5:10} trunks", ranks: [], columns: [], color: '', difficulty: 'easy', type: 'multi' },
            { id: 'dig_times_2', text: "Dig {5:10} times", ranks: [], columns: [], color: 'green', difficulty: 'easy', type: 'multi' },
            { id: 'outer_rooms', text: "Draft a {outer_room} outside", ranks: [], columns: [], color: 'green', difficulty: 'easy', type: 'multi' },
            { id: 'red_letter_2', text: "Read {3:5} red letters", ranks: [], columns: [], color: 'red', difficulty: 'medium', type: 'multi' },
                               
            //Medium challenges multi
            { id: 'reach_basement_1', text: "Reach the basement", ranks: [5,6,7], columns: [], color: '', difficulty: 'hard', type: 'multi'},
            { id: 'time_safe_1', text: "Open a time safe", ranks: [5,6,7], columns: [1,5], color: 'red', difficulty: 'hard', type: 'multi'},
            { id: 'light_candle_1', text: "Light a candle", ranks: [5,6,7], columns: [1,5], color: '', difficulty: 'medium', type: 'multi' },
            { id: 'blackthorn_grotto_1', text: "Open blackthorn grotto", ranks: [6,7], columns: [], color: '', difficulty: 'hard', type: 'multi' },
            { id: 'find_microchip_1', text: "Find a microchip", ranks: [3,4,5,6,7], columns: [1,5], color: '', difficulty: 'medium', type: 'multi' },
            { id: 'buy_showroom_1', text: "Buy an item from the showroom", ranks: [3,4,5,6,7], columns: [1,5], color: 'yellow', difficulty: 'medium', type: 'multi' },
            { id: 'raise_allowance_1', text: "Raise your allowance to {4:10}", ranks: [5,6,7], columns: [1,5], color: '', difficulty: 'hard', type: 'multi' },
            { id: 'break_brick_wall_1', text: "Break a brick wall", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'multi' },
            { id: 'add_new_rooms_1', text: "Add {1:3} new rooms to your draft pool", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'multi' },
            { id: 'get_crown_1', text: "Get a crown", ranks: [], columns: [6,7], color: '', difficulty: 'medium', type: 'multi' },
            { id: 'get_crafted_item_1', text: "Get a {crafted_item}", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'multi' },
            { id: 'inventory_items_2', text: "Have {6:10} inventory items", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'multi' },
            { id: 'over_60_steps_1', text: "Have over 100 steps", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'multi' },
            { id: 'end_with_steps_1', text: "End the day with {50:80}+ steps", ranks: [3,4,5,6,7], columns: [], color: '', difficulty: 'medium', type: 'multi' },
            { id: 'estate_size_1', text: "End a day with a {estateSize}", ranks: [5,6,7], columns: [1,5], color: '', difficulty: 'medium', type: 'multi' },
            { id: 'draft_room_in_square', text: "Draft {common_room} in this position on your map.", ranks: [], columns: [], color: '', difficulty: 'medium', type: 'multi' },
            { id: 'mora_jai', text: "Complete a mora jai puzzle box", ranks: [], columns: [], color: '', difficulty: 'medium', type: 'multi' },
            { id: 'reach_stars', text: "Have {3:10} stars", ranks: [], columns: [], color: '', difficulty: 'medium', type: 'multi' },
            { id: 'empty_water', text: "Empty a watering can", ranks: [], columns: [], color: 'green', difficulty: 'medium', type: 'multi' },
            
            //Hard challenges multi
            { id: 'west_gate_path_1', text: "Unlock West Gate Path", ranks: [6,7], columns: [1], color: '', difficulty: "hard", type: "multi" },
            { id: 'drain_reservoir_1', text: "Drain the reservoir", ranks: [6,7], columns: [], color: 'blue', difficulty: "hard", type: "multi" },
            { id: 'ride_elevator_1', text: "Ride an elevator", ranks: [4,5,6,7], columns: [], color: '', difficulty: 'hard', type: 'multi' },
            { id: 'win_roulette_1', text: "Win at roulette", ranks: [5,6,7], columns: [1,5], color: 'yellow', difficulty: 'hard', type: 'multi' },
            { id: 'fill_house_1', text: "Fill every square in the house", ranks: [5,6,7], columns: [], color: '', difficulty: 'hard', type: 'multi' },
            { id: 'sanctum_key_1', text: "Find a sanctum key", ranks: [6,7], columns: [1,5], color: '', difficulty: 'hard', type: 'multi' },
            { id: 'estate_type_1', text: "End a day with a {estateType}", ranks: [5,6,7], columns: [1,5], color: '', difficulty: 'hard', type: 'multi' },
            { id: 'chess', text: "Gain a chess power", ranks: [6,7], columns: [1,5], color: '', difficulty: 'hard', type: 'multi' }
            
        ];

        const commonRooms = [
            "drawing room", "parlor", "spare room", "billiard room", "closet", "storeroom", "nook",
            "dining room",  "pantry", "hallway", "den", "wine cellar", "pantry", "utility closet",
            "guest room", "bedroom", "security", "observatory", "bedroom", "boudoir", "west wing hall", "east wing hall",
            "corridor", "passageway", "courtyard", "kitchen", "gymnasium", "commissary", "aquarium"
        ];
        
        const rareRooms = [
             "laboratory", "workshop", "vault", "secret passage", "locksmith", "showroom", "laundry room",
             "greenhouse", "cloister", "veranda", "patio", "foyer", "great hall",
             "hr ladyship's chamber", "master bedroom", "mail room", "coat check", "pump room", "boiler", "pool room",
             "drawing room", "library", "rumpus room", "vault", "trophy room", "attic", "gallery"
        ];

        // Game configuration data
        const roomTypes = ["shop", "garden", "red", "blue", "mechanical", "hallway", "bedroom"];

        const foodTypes = ["apple", "turnip", "orange", "banana"];

        const items = [
            "compass", "magnifying glass", "coin purse", "rabbit's foot", "metal detector", "shovel", "sledgehammer", "broken lever",
            "lockpick", "battery pack", "watering can", "keycard", "secret garden key", "car keys", "silver key", "sleeping mask", "salt shaker",
            "wind-up key", "running shoes"
        ];

        const craftedItems = [
            "lucky purse", "powered electromagnet", "Dowsing rod", "power hammer", "pick sound amplifier", "detector shovel", "jack hammer", "burning glass"
        ];

        const estateSize = [
            "Abandoned Project (Less than 5 rooms)", "Humble Bungalow (Between 5-10 rooms)", "Charming Cottage (Between 10-20 rooms)", 
            "Respectable Villa (Between 20-30 rooms)", "Impressive Manor (30-40 Rooms)", "Opulent Chateau (40+ rooms)"
        ];


        const estateTypes= [
            "Academic Estate (5+ classrooms/libraries)", "Archaelogical Estate (18+ Excavated Dig Spots)", "East Facing Estate (East wing favoured)",
            "West Facing Estate (West wing favoured)", "Red Estate (5-6 red rooms)", "Garden Estate (3+ Green Rooms)"
        ];

        const drawings= [
            "dessert", "desert", "praying", "prybar", "face", "ace", "stag", "tag", "plane", "plan", "stair", "star",
            "bridge", "bride", "bath", "bat", "cart", "car", "tie", "road", "rod", "tree", "tiger", "chart", "planet", "clock"            
        ];

        const outerRooms= [
            "toolshed", "shelter", "schoolhouse", "shrine", "root cellar", "hovel", "trading post", "tomb"            
        ];

        // Colors for grid squares
        const colors = ['yellow', 'blue', 'green', 'red', 'orange', 'purple'];


        // Define incompatible challenge groups
        const incompatibleGroups = [
            ['over_100_steps_1', 'over_60_steps_1'], // Steps challenges
            ['parlor_puzzle_1', 'parlor_puzzles_multi_1'], // Single vs multiple parlor
            ['dartboard_puzzle_1', 'dartboard_puzzles_multi_1'], // Single vs multiple dartboard
            ['lab_experiment_1', 'lab_experiment_multi_1'], // Single vs multiple lab experiments
            ['end_in_roomtype_1', 'end_rare_room_1'], // Different end location requirements
            ['buy_shop', 'buy_multi_shop'], //Multiple shop room purchases
            ['keys_at_once_1', 'keys_at_once_2'], //multiple keys at once requirements
            ['gems_at_once_1', 'gems_at_once_2'], //multiple gems at once requirements
            ['coins_at_once_1', 'coins_at_once_2'] //multiple coins at once requirements
        ];

        function isCompatibleChallenge(challengeId, usedChallenges) {
            for (const group of incompatibleGroups) {
                if (group.includes(challengeId)) {
                    // Check if any other challenge in this group is already used
                    const hasConflict = group.some(id => id !== challengeId && usedChallenges.has(id));
                    if (hasConflict) {
                        return false;
                    }
                }
            }
            return true;
        }

        /**
         * A deterministic random number generator that produces the same sequence of numbers
         * for a given seed, ensuring consistent game generation across sessions.
         */
        class SeededRandom {
            /**
             * Creates a new seeded random number generator
             * @param {string|number} seed - The seed value to initialize the RNG
             */
            constructor(seed) {
                this.seed = this.hashCode(seed.toString());
            }
            
            /**
             * Generates a hash code from a string
             * @param {string} str - String to hash
             * @returns {number} A 32-bit positive integer hash
             */
            hashCode(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32-bit integer
                }
                return Math.abs(hash);
            }
            
            /**
             * Generates the next random number in the sequence
             * @returns {number} A number between 0 and 1
             */
            next() {
                this.seed = (this.seed * 9301 + 49297) % 233280;
                return this.seed / 233280;
            }
            
            /**
             * Generates a random integer within a range
             * @param {number} min - Minimum value (inclusive)
             * @param {number} max - Maximum value (inclusive)
             * @returns {number} A random integer between min and max
             */
            nextInt(min, max) {
                return Math.floor(this.next() * (max - min + 1)) + min;
            }
            
            /**
             * Shuffles an array in-place
             * @param {Array} array - The array to shuffle
             * @returns {Array} The shuffled array
             */
            shuffle(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(this.next() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }
        }

        // Get today's seed
        function getSeed() {
            if (useRandomSeed) {
                return randomSeed;
            }
            const today = new Date();
            return `${today.getFullYear()}-${today.getMonth()}-${today.getDate()}`;
        }

        // Process challenge text with ranges
        function processChallenge(challenge, rng) {
            let text = challenge.text;
            
            // Process number ranges first
            const rangeMatch = text.match(/\{(\d+):(\d+)\}/);
            if (rangeMatch) {
                const min = parseInt(rangeMatch[1]);
                const max = parseInt(rangeMatch[2]);
                const value = rng.nextInt(min, max);
                text = text.replace(rangeMatch[0], value);
            }
            
            // Process room selections - use while loops to handle multiple instances
            while (text.includes('{common_room}')) {
                const room = commonRooms[rng.nextInt(0, commonRooms.length - 1)];
                text = text.replace('{common_room}', room);
            }
            
            while (text.includes('{rare_room}')) {
                const room = rareRooms[rng.nextInt(0, rareRooms.length - 1)];
                text = text.replace('{rare_room}', room);
            }

            while (text.includes('{outer_room}')) {
                const room = outerRooms[rng.nextInt(0, outerRooms.length - 1)];
                text = text.replace('{outer_room}', room);
            }

            while (text.includes('{roomtype}')) {
                const room = roomTypes[rng.nextInt(0, roomTypes.length - 1)];
                text = text.replace('{roomtype}', room);
            }

            while (text.includes('{foodtype}')) {
                const room = foodTypes[rng.nextInt(0, foodTypes.length - 1)];
                text = text.replace('{foodtype}', room);
            }

            while (text.includes('{item}')) {
                const item = items[rng.nextInt(0, items.length - 1)];
                text = text.replace('{item}', item);
            }

            while (text.includes('{crafted_item}')) {
                const item = craftedItems[rng.nextInt(0, craftedItems.length - 1)];
                text = text.replace('{crafted_item}', item);
            }

            while (text.includes('{estateSize}')) {
                const size= estateSize[rng.nextInt(0, estateSize.length - 1)];
                text = text.replace('{estateSize}', size);
            }

            while (text.includes('{estateType}')) {
                const estate = estateTypes[rng.nextInt(0, estateTypes.length - 1)];
                text = text.replace('{estateType}', estate);
            }

            while (text.includes('{drawings}')) {
                const picture = drawings[rng.nextInt(0, drawings.length - 1)];
                text = text.replace('{drawings}', picture);
            }
            
            return { ...challenge, text };
        }

        // Generate grid
        function generateGrid() {
            const seed = getSeed();
            gameState.seed = seed;
            const rng = new SeededRandom(seed + gameState.mode);
            
            const grid = [];
            const isDraft = gameState.mode.includes('draft');
            
            // Initialize 5x7 grid
            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 5; col++) {
                    const index = row * 5 + col;
                    let cell = {
                        row, col, index,
                        isLobby: row === 6 && col === 2, // Switch: lobby now at top
                        isGoal: row === 0 && col === 2,  // Switch: goal now at bottom
                        isLocked: false,
                        challenge: null,
                        color: '',
                        hasGem: false,
                        hasKey: false,
                        hasDice: false,
                        isCompleted: false,
                        isExplored: isDraft ? (row === 6 && col === 2) : true // Update for new lobby position
                    };
                    
                    // Don't add challenges to lobby or goal
                    if (!cell.isLobby && !cell.isGoal) {
                        // Add some locked cells, but not adjacent to start (lobby)
                        const isAdjacentToLobby = (
                            (row === 5 && col === 2) || // below lobby
                            (row === 6 && col === 1) || // left of lobby  
                            (row === 6 && col === 3)    // right of lobby
                        );
                        
                        if (!isAdjacentToLobby && rng.next() < 0.15) {
                            cell.isLocked = true;
                        }
                                               
                        // Add resources
                        const resourceRoll = rng.next();
                        if (resourceRoll < 0.10) cell.hasGem = true;
                        else if (resourceRoll < 0.25) cell.hasKey = true;
                        else if (resourceRoll < 0.35) cell.hasDice = true;
                        
                        // Add challenges if not draft mode or if explored
                        if (!isDraft || cell.isExplored) {
                            // Pass correct rank (1-7) and column (1-5) values
                            cell.challenge = selectChallenge(7 - row, col + 1, cell.color, rng);
                        }
                    }
                    
                    grid.push(cell);
                }
            }
            
            gameState.grid = grid;
            gameState.exploredCells = isDraft ? new Set([32]) : new Set(grid.map((_, i) => i)); // Update for new lobby position (row 6, col 2 = index 32)
        }

        // Select appropriate challenge for cell
        function selectChallenge(rank, column, color, rng, forceColor = false) {
            const isMultiMode = gameState.mode.includes('weekly');
            
            // Enhanced debug logging - start of function
            console.log(`\n=== SELECTING CHALLENGE ===`);
            console.log(`Position: Rank ${rank}, Column ${column}, Color: ${color || 'none'}`);
            console.log(`Mode: ${gameState.mode} (isMulti: ${isMultiMode}), forceColor: ${forceColor}`);
            
            // Priority 1: Row and column requirements must be correct
            let validChallenges = challenges.filter(c => {
                const rankValid = c.ranks.length === 0 || c.ranks.includes(rank);
                const columnValid = c.columns.length === 0 || c.columns.includes(column);
                
                // NEW COLOR LOGIC:
                let colorValid;
                if (forceColor && color) {
                    // When forcing a color (dice reroll or colored draft), only allow that color
                    colorValid = c.color === color;
                } else if (color) {
                    // Cell has color - allow matching color challenges OR no-color challenges
                    colorValid = (c.color === color);
                } else {
                    // Cell has no color - allow any challenge
                    colorValid = true;
                }
                
                const typeValid = isMultiMode ? 
                    (c.type === 'multi' || c.type === 'none') : 
                    (c.type === 'daily' || c.type === 'none');
                const hasRankConstraint = c.ranks.length > 0;
                const hasColumnConstraint = c.columns.length > 0;

                // If a challenge has specific rank/column requirements, it must meet ALL of them
                if (hasRankConstraint && !c.ranks.includes(rank)) return false;
                if (hasColumnConstraint && !c.columns.includes(column)) return false;

                return rankValid && columnValid && colorValid && typeValid;
            });

            console.log(`Found ${validChallenges.length} valid challenges after initial filtering`);
                            
            if (validChallenges.length === 0) {
                console.warn('❌ No valid challenges found - using fallback');
                return { id: 'fallback', text: 'No challenges - Free room', difficulty: 'easy', type: 'daily' };
            }

            // Priority 2: Filter out incompatible challenges
            let compatibleChallenges = validChallenges.filter(c => 
                isCompatibleChallenge(c.id, gameState.usedChallenges)
            );

            console.log(`${compatibleChallenges.length} challenges remain after compatibility filtering`);
            if (compatibleChallenges.length < validChallenges.length) {
                const filtered = validChallenges.filter(c => !isCompatibleChallenge(c.id, gameState.usedChallenges));
                console.log(`Filtered out incompatible: [${filtered.map(c => c.id).join(', ')}]`);
            }

            // Priority 3: Try to avoid duplicates
            let unusedChallenges = compatibleChallenges.filter(c => 
                !gameState.usedChallenges.has(c.id)
            );

            console.log(`${unusedChallenges.length} unused challenges available`);
            if (unusedChallenges.length < compatibleChallenges.length) {
                const used = compatibleChallenges.filter(c => gameState.usedChallenges.has(c.id));
                console.log(`Already used: [${used.map(c => c.id).join(', ')}]`);
            }

            // Use the most restrictive set available
            let finalChallenges;
            if (unusedChallenges.length > 0) {
                finalChallenges = unusedChallenges;
                console.log(`✓ Using ${finalChallenges.length} unused challenges`);
            } else if (compatibleChallenges.length > 0) {
                finalChallenges = compatibleChallenges;
                console.log(`⚠ Using ${finalChallenges.length} compatible challenges (allowing duplicates)`);
            } else {
                finalChallenges = validChallenges;
                console.log(`⚠ Using ${finalChallenges.length} valid challenges (ignoring compatibility)`);
            }
            
            const challengeIndex = rng.nextInt(0, finalChallenges.length - 1);
            const challenge = finalChallenges[challengeIndex];
            const processedChallenge = processChallenge(challenge, rng);
            
            // Final selection logging
            console.log(`\n🎯 SELECTED: ${challenge.id} (index ${challengeIndex} of ${finalChallenges.length})`);
            console.log(`   Original text: "${challenge.text}"`);
            console.log(`   Processed text: "${processedChallenge.text}"`);
            console.log(`   Challenge requirements met:`);
            console.log(`     Rank ${rank}: ${challenge.ranks.length === 0 ? 'no restriction' : `must be in [${challenge.ranks.join(', ')}]`} ${challenge.ranks.length === 0 || challenge.ranks.includes(rank) ? '✓' : '✗'}`);
            console.log(`     Column ${column}: ${challenge.columns.length === 0 ? 'no restriction' : `must be in [${challenge.columns.join(', ')}]`} ${challenge.columns.length === 0 || challenge.columns.includes(column) ? '✓' : '✗'}`);
            console.log(`     Color ${color || 'none'}: ${!challenge.color ? 'no restriction' : `must be ${challenge.color}`} ${!challenge.color || !color || challenge.color === color ? '✓' : '✗'}`);
            console.log(`=== END SELECTION ===\n`);
            
            gameState.usedChallenges.add(challenge.id);
            
            return processedChallenge;
        }

        // Render grid
        function renderGrid() {
            const gridElement = document.getElementById('game-grid');
            gridElement.innerHTML = '';
            
            gameState.grid.forEach((cell, index) => {
                const cellElement = document.createElement('div');
                cellElement.className = 'cell';
                cellElement.dataset.index = index;
                
                if (cell.isLobby) {
                    cellElement.classList.add('lobby');
                    cellElement.innerHTML = '<div></div><div style="font-size:8px;">LOBBY</div>';
                } else if (cell.isGoal) {
                    cellElement.classList.add('goal');
                    cellElement.innerHTML = '<div></div><div style="font-size:8px;">ANTECHAMBER</div>';
                } else if (cell.isLocked) {
                    cellElement.classList.add('locked');
                    cellElement.innerHTML = '<div>🔒</div>';
                } else if (!cell.isExplored && gameState.mode.includes('draft')) {
                    cellElement.innerHTML = '<div class="hidden-challenge">?</div>';
                } else if (cell.challenge) {
                    if (cell.color) cellElement.classList.add(cell.color);
                    if (cell.isCompleted) cellElement.classList.add('completed');
                    
                    cellElement.innerHTML = `<div class="challenge-text">${cell.challenge.text}</div>`;
                }
                
                // Add resource icons
                let resourceIcons = '';
                if (cell.hasGem) resourceIcons += '💎';
                if (cell.hasKey) resourceIcons += '🔑';
                if (cell.hasDice) resourceIcons += '🎲';
                if (resourceIcons) {
                    cellElement.innerHTML += `<div class="resource-icon">${resourceIcons}</div>`;
                }
                
                cellElement.addEventListener('click', () => handleCellClick(index));
                gridElement.appendChild(cellElement);
            });
            
            updatePathDisplay();
        }

        // Handle cell click
        function handleCellClick(index) {
            const cell = gameState.grid[index];
            
            if (gameState.selectedResource) {
                handleResourceUse(index);
                return;
            }
            
            // Allow uncompleting completed cells
            if (cell.isCompleted && !cell.isLobby && !cell.isGoal) {
                cell.isCompleted = false;
                renderGrid();
                checkWinCondition();
                return;
            }
            
            // Draft mode exploration
            if (gameState.mode.includes('draft') && !cell.isExplored && !cell.isLobby && !cell.isGoal) {
                const adjacentToExplored = isAdjacentToExplored(index);
                if (adjacentToExplored) {
                    showDraftOptions(index);
                    return;
                }
            }
            
            // Complete challenges
            if ((cell.challenge || cell.isLobby) && !cell.isCompleted && !cell.isLocked) {
                completeCell(index);
                checkWinCondition(index);
            }
            updateScoreDisplay();
        }

        // Check if cell is adjacent to explored AND completed cell
        function isAdjacentToExplored(index) {
            const cell = gameState.grid[index];
            const adjacents = [
                index - 5, // up
                index + 5, // down
                index - 1, // left
                index + 1  // right
            ].filter(i => {
                if (i < 0 || i >= 35) return false;
                const adjCell = gameState.grid[i];
                if (Math.abs(adjCell.col - cell.col) > 1) return false;
                return gameState.exploredCells.has(i) && (adjCell.isCompleted || adjCell.isLobby);
            });
            
            return adjacents.length > 0;
        }
        
        /**
         * Common logic for challenge filtering and selection
         * @param {number} rank - The rank position 
         * @param {number} column - The column position
         * @param {string} color - The color constraint
         * @param {boolean} forceColor - Whether to enforce color matching
         * @returns {Array} Array of valid challenges
         */
        function filterChallenges(rank, column, color, forceColor = false) {
            const isMultiMode = gameState.mode.includes('weekly');
            
            return challenges.filter(c => {
                const rankValid = !c.ranks.length || c.ranks.includes(rank);
                const columnValid = !c.columns.length || c.columns.includes(column);
                const colorValid = forceColor ? 
                    (!color || c.color === color) : 
                    (!color || !c.color || c.color === color);
                const typeValid = isMultiMode ? 
                    (c.type === 'multi' || c.type === 'none') : 
                    (c.type === 'daily' || c.type === 'none');
                    
                return rankValid && columnValid && colorValid && typeValid;
            });
        }

        /**
         * Generates a challenge option for draft mode
         */
        function generateChallengeOption(rank, column, color, rng, forceColor = false) {
            const validChallenges = filterChallenges(rank, column, color, forceColor);
            
            if (!validChallenges.length) {
                return { id: 'fallback', text: 'Free room :)', difficulty: 'easy', type: 'daily' };
            }
            
            // Filter out incompatible challenges
            const compatibleChallenges = validChallenges.filter(c => 
                isCompatibleChallenge(c.id, gameState.usedChallenges)
            );
            
            // Try to avoid duplicates
            const unusedChallenges = compatibleChallenges.filter(c => 
                !gameState.usedChallenges.has(c.id)
            );
            
            // Use the most restrictive set available
            let finalChallenges;
            if (unusedChallenges.length > 0) {
                finalChallenges = unusedChallenges;
            } else if (compatibleChallenges.length > 0) {
                finalChallenges = compatibleChallenges;
            } else if (validChallenges.length > 0) {
                finalChallenges = validChallenges;
            } else {
                return { id: 'fallback', text: 'Free room :)', difficulty: 'easy', type: 'daily' };
            }
            
            const challengeIndex = rng.nextInt(0, finalChallenges.length - 1);
            const challenge = finalChallenges[challengeIndex];
            return processChallenge(challenge, rng);
        }

        // Show draft options
        function showDraftOptions(index) {
            const cell = gameState.grid[index];
            const seed = gameState.seed + index;
            const rng = new SeededRandom(seed);
            
            const options = [];
            const attempts = [];
            
            // Generate more attempts to ensure we get valid options
            for (let i = 0; i < 10; i++) {
                const challenge = generateChallengeOption(7 - cell.row, cell.col + 1, cell.color, rng);
                attempts.push(challenge);
            }

            // Remove duplicates and take first 2-3 regular options
            const uniqueOptions = [];
            const seenIds = new Set();
            
            for (const attempt of attempts) {
                if (!seenIds.has(attempt.id) && uniqueOptions.length < 2) {
                    seenIds.add(attempt.id);
                    uniqueOptions.push(attempt);
                }
            }
            
            // Add random color option with 30% chance
            if (rng.next() < 0.3) {
                const availableColors = colors.filter(color => {
                    // Check if there are valid challenges for this color
                    const colorChallenges = challenges.filter(c => {
                        const rankValid = c.ranks.length === 0 || c.ranks.includes(7 - cell.row);
                        const columnValid = c.columns.length === 0 || c.columns.includes(cell.col + 1);
                        const colorValid = !c.color || c.color === color;
                        const typeValid = gameState.mode.includes('weekly') ? 
                            (c.type === 'multi' || c.type === 'none') : 
                            (c.type === 'daily' || c.type === 'none');
                        return rankValid && columnValid && colorValid && typeValid;
                    });
                    return colorChallenges.length > 0;
                });
                
                if (availableColors.length > 0) {
                    const randomColor = availableColors[rng.nextInt(0, availableColors.length - 1)];
                    uniqueOptions.push({
                        id: 'random_color',
                        text: `Random ${randomColor} challenge`,
                        isRandomColor: true,
                        targetColor: randomColor
                    });
                }
            }
            
            // Fill with duplicates if needed to reach 3 options
            while (uniqueOptions.length < 3 && attempts.length > 0) {
                uniqueOptions.push(attempts[uniqueOptions.length % attempts.length]);
            }
            
            const modal = document.getElementById('draft-modal');
            const optionsContainer = document.getElementById('draft-options');
            optionsContainer.innerHTML = '';
            
            uniqueOptions.forEach((option, i) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'draft-option';
                if (option.isRandomColor) {
                    optionElement.classList.add(option.targetColor);
                }
                optionElement.textContent = option.text;
                optionElement.addEventListener('click', () => {
                    selectDraftOption(index, option);
                    modal.style.display = 'none';
                });
                optionsContainer.appendChild(optionElement);
            });
            
            modal.style.display = 'flex';
        }

        // Select draft option
        function selectDraftOption(index, challengeOption) {
            const cell = gameState.grid[index];
            
            if (challengeOption.isRandomColor) {
                cell.color = challengeOption.targetColor;
                const seed = gameState.seed + index + 'random';
                const rng = new SeededRandom(seed);
                cell.challenge = selectChallenge(7 - cell.row, cell.col + 1, challengeOption.targetColor, rng, true);
            } else {
                cell.challenge = challengeOption;
                // Add the challenge ID to used challenges (this was already correct)
                gameState.usedChallenges.add(challengeOption.id);
            }
            
            cell.isExplored = true;
            gameState.exploredCells.add(index);
            renderGrid();
            saveGameState();
        }

        // Handle resource use
        function handleResourceUse(index) {
            const cell = gameState.grid[index];
            const resource = gameState.selectedResource;
            
            if (resource === 'keys' && cell.isLocked && gameState.resources.keys > 0) {
                cell.isLocked = false;
                gameState.resources.keys--;
                showNotification('🔑 Lock removed!');
            } else if (resource === 'dice' && cell.challenge && gameState.resources.dice > 0) {
                showColorPicker(index);
                //gameState.resources.dice--;
                showNotification('🎲 Challenge rerolled!');
            } else if (resource === 'gems' && cell.challenge && gameState.resources.gems > 0) {
                const rangeMatch = cell.challenge.text.match(/\d+/);
                if (rangeMatch) {
                    const originalValue = parseInt(rangeMatch[0]);
                    if (originalValue > 1) {
                        const reducedValue = Math.max(1, Math.floor(originalValue * 0.7)); // Reduce by 10%
                        cell.challenge.text = cell.challenge.text.replace(rangeMatch[0], reducedValue);
                        gameState.resources.gems--;
                        showNotification('💎 Requirement reduced!');
                    } else {
                        showNotification('💎 Cannot reduce further!');
                    }
                }
            } else {
                showNotification('❌ Cannot use that here!');
            }
            
            gameState.selectedResource = null;
            document.querySelectorAll('.resource-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            updateResourceDisplay();
            renderGrid();
            saveGameState();
        }

        // Complete cell
        function completeCell(index) {
            const cell = gameState.grid[index];
            cell.isCompleted = true;
            
            // Collect resources
            if (cell.hasGem) {
                gameState.resources.gems++;
                cell.hasGem = false;
            }
            if (cell.hasKey) {
                gameState.resources.keys++;
                cell.hasKey = false;
            }
            if (cell.hasDice) {
                gameState.resources.dice++;
                cell.hasDice = false;
            }
            
            updateResourceDisplay();
            updateScoreDisplay();
            renderGrid();
            checkEmailTriggers();
            saveGameState();
        }

        // Check win condition
        function checkWinCondition(triggeredIndex = null) {
            const path = findPath();
            const wasIncomplete = !gameState.isComplete;

            if (path.length > 0) {
                gameState.isComplete = true;
                gameState.completedPath = path;

                // Only update stats and show modal if this is a new completion
                if (wasIncomplete && triggeredIndex !== null && path.includes(triggeredIndex)) {
                    // Update stats
                    gameState.stats.completedRuns++;
                    gameState.stats.totalGems += gameState.resources.gems;
                    gameState.stats.totalKeys += gameState.resources.keys;
                    gameState.stats.totalDice += gameState.resources.dice;
                    
                    const currentScore = calculateScore();
                    if (currentScore > gameState.stats.highScore) {
                        gameState.stats.highScore = currentScore;
                    }
                    
                    // Save stats to localStorage
                    localStorage.setItem('blueprince_stats', JSON.stringify(gameState.stats));
                    
                    // Record this path completion
                    gameState.completedPaths.add(gameState.seed);
                    
                    // Show notification instead of modal
                    showNotification('🎉 Path Complete! +10 points');
                    
                    // Check for first-time path completion email
                    if (!gameState.emailTriggers.pathComplete) {
                        emailSystem.sendEmail({
                            id: 'first-path-complete',
                            subject: '🎉 First Path Completed!',
                            content: `
                            <div class="email-section">
                                <h3>Welcome to the SYNKA Algorithm Project.</h3>
                                <p>Randolph Moore here from SYNKA! I wanted to personally congratulate you on completing your first successful navigation of Mt Holly.</p>
                                <p>Your path data has been added to our algorithmic analysis program. Every unique route you discover helps us better understand the estate's shifting nature.</p>
                                <p>I've been working here for over a decade alongside Herbert, and I must say, it's refreshing to see new approaches to exploration.</p>
                                <p>Keep up the excellent work!</p>
                                <p>Best regards,<br>Randolph Moore<br>Head Lab Technician, SYNKA</p>
                                <p></p>
                                <p>Your current stats:</p>
                                <ul>
                                    <li>Paths Completed: ${gameState.stats.completedRuns}</li>
                                    <li>High Score: ${gameState.stats.highScore}</li>
                                </ul>
                            </div>`
                        });
                        gameState.emailTriggers.pathComplete = true;
                    }
                }
            } else {
                gameState.isComplete = false;
                gameState.completedPath = [];
            }

            updatePathDisplay();
            updateScoreDisplay();
        }

        // Find path from lobby to goal
        function findPath() {
            const start = gameState.grid.findIndex(cell => cell.isLobby && cell.isCompleted);
            const goal = gameState.grid.findIndex(cell => cell.isGoal);
            
            if (start === -1) return [];
            
            const queue = [[start]];
            const visited = new Set([start]);
            
            while (queue.length > 0) {
                const path = queue.shift();
                const current = path[path.length - 1];
                
                if (current === goal) return path;
                
                const currentCell = gameState.grid[current];
                const adjacents = [
                    current - 5, // up
                    current + 5, // down
                    current - 1, // left
                    current + 1  // right
                ].filter(i => {
                    if (i < 0 || i >= 35) return false;
                    if (visited.has(i)) return false;
                    
                    const adjCell = gameState.grid[i];
                    if (Math.abs(adjCell.col - currentCell.col) > 1) return false;
                    
                    // Allow movement to goal cell even if not completed, but other cells must be completed
                    return adjCell.isCompleted || adjCell.isGoal;
                });
                
                adjacents.forEach(adj => {
                    visited.add(adj);
                    queue.push([...path, adj]);
                });
            }
            
            return [];
        }

        // Update path display
        function updatePathDisplay() {
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('path');
            });
            
            if (gameState.completedPath.length > 0) {
                gameState.completedPath.forEach(index => {
                    const cellElement = document.querySelector(`[data-index="${index}"]`);
                    if (cellElement) cellElement.classList.add('path');
                });
            }
        }

        // Show completion modal
        // Show path completion notification handled in checkWinCondition()

        // Copy result to clipboard
        function copyResult() {
            let result = '';
            const score = calculateScore();
            const isMulti = gameState.mode.includes('weekly');
            const days = isMulti ? (parseInt(document.getElementById('days-counter').value) || 1) : 1;
            
            const modeNames = {
                'daily-std': 'Standard Expedition',
                'weekly-std': 'Standard Campaign', 
                'daily-draft': 'Draft Expedition',
                'weekly-draft': 'Draft Campaign'
            };
            
            // Show seed info
            const seedInfo = useRandomSeed ? gameState.seed : 'Daily';
            
            result += `Blue Prince ${modeNames[gameState.mode]}\n`;
            result += `Seed: ${seedInfo}\n`;
            result += `Score: ${score}`;
            if (isMulti) result += ` (${days} days)`;
            result += '\n';
            
            // Show leftover resources
            const { gems, keys, dice } = gameState.resources;
            if (gems > 0 || keys > 0 || dice > 0) {
                result += `Resources: `;
                const resources = [];
                if (gems > 0) resources.push(`${gems} 💎`);
                if (keys > 0) resources.push(`${keys} 🔑`);
                if (dice > 0) resources.push(`${dice} 🎲`);
                result += resources.join(', ') + '\n';
            }
            result += '\n';
            
            // Create emoji grid
            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 5; col++) {
                    const index = row * 5 + col;
                    const cell = gameState.grid[index];
                    
                    if (gameState.completedPath.includes(index)) {
                        result += '🟩';
                    } else if (cell.isCompleted) {
                        result += '🟢';
                    } else {
                        result += '⬜';
                    }
                }
                result += '\n';
            }
            result += '\n';
            result += `Play game: https://samcardwell44.github.io/Mt-Holly-Daily-Challenge/`;
            result += '\n';
            
            navigator.clipboard.writeText(result).then(() => {
                showNotification('📋 Result shared to clipboard!');
            });
        }

        // Show notification
        function showNotification(text) {
            const notification = document.getElementById('notification');
            notification.textContent = text;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Update resource display
        function updateResourceDisplay() {
            document.getElementById('gem-count').textContent = gameState.resources.gems;
            document.getElementById('key-count').textContent = gameState.resources.keys;
            document.getElementById('dice-count').textContent = gameState.resources.dice;
        }

        // Initialize game
        function clearSavedGame(mode, seed) {
            const key = `blueprince_${mode}_${seed}`;
            localStorage.removeItem(key);
        }

        /**
         * Initialize or reset the game state
         * @param {boolean} forceNew - Whether to force a new game even if saved state exists
         */
        function initGame(forceNew = false) {
            const seed = getSeed();
            
            // Load saved stats
            const savedStats = localStorage.getItem('blueprince_stats');
            if (savedStats) {
                gameState.stats = JSON.parse(savedStats);
            }
            
            // Try loading saved state first
            if (!forceNew && loadGameState(gameState.mode, seed)) {
                updateDisplays();
                return;
            }
            
            // Clear any existing saved game
            clearSavedGame(gameState.mode, seed);
            
            // Reset game state
            resetGameState();
            
            // Configure UI for game mode
            configureGameMode();
            
            // Initialize email system
            emailSystem.init();
            
            // Generate new game grid
            generateGrid();

            const lobbyCellIndex = gameState.grid.findIndex(cell => cell.isLobby);
            if (lobbyCellIndex !== -1) {
                gameState.grid[lobbyCellIndex].isCompleted = true;
            }
            updateDisplays();
        }

        /**
         * Reset all game state to initial values
         */
        function resetGameState() {
            gameState.resources = { gems: 0, keys: 0, dice: 0 };
            gameState.selectedResource = null;
            gameState.completedPath = [];
            gameState.isComplete = false;
            gameState.exploredCells = new Set();
            gameState.usedChallenges = new Set();
        }

        /**
         * Configure UI elements based on game mode
         */
        function configureGameMode() {
            const daysControl = document.getElementById('days-control');
            if (gameState.mode.includes('weekly')) {
                daysControl.style.display = 'block';
                document.getElementById('days-counter').value = 1;
            } else {
                daysControl.style.display = 'none';
            }
        }

        /**
         * Update all game displays
         */
        function updateDisplays() {
            renderGrid();
            updateResourceDisplay();
            updateScoreDisplay();
        }

        /**
         * Calculate the current game score
         */
        function calculateScore() {
            const completedCount = gameState.grid.filter(cell => cell.isCompleted).length;
            const hasPath = gameState.isComplete ? 10 : 0; 
            let score = completedCount + hasPath;
            
            if (gameState.mode.includes('weekly')) {
                const days = parseInt(document.getElementById('days-counter').value) || 1;
                score = Math.max(0, score - (days - 1));
            }
            
            return score;
        }

        function updateScoreDisplay() {
            document.getElementById('score-display').textContent = calculateScore();
        }

        function shareResult() {
            let result = '';
            const score = calculateScore();
            const isMulti = gameState.mode.includes('weekly');
            const days = isMulti ? (parseInt(document.getElementById('days-counter').value) || 1) : 1;
            
            const modeNames = {
                'daily-std': 'Standard Expedition',
                'weekly-std': 'Standard Campaign', 
                'daily-draft': 'Draft Expedition',
                'weekly-draft': 'Draft Campaign'
            };
                        
            result += `Blue Prince ${modeNames[gameState.mode]}\n`;
            result += `Score: ${score}`;
            if (isMulti) result += ` (${days} days)`;
            result += '\n\n';
            
            // Create emoji grid
            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 5; col++) {
                    const index = row * 5 + col;
                    const cell = gameState.grid[index];
                    
                    if (gameState.completedPath.includes(index)) {
                        result += '🟩';
                    } else if (cell.isCompleted) {
                        result += '🟢';
                    } else {
                        result += '⬜';
                    }
                }
                result += '\n';
            }
            
            navigator.clipboard.writeText(result).then(() => {
                showNotification('📋 Result shared to clipboard!');
            });
        }

        function showColorPicker(index) {
            const modal = document.createElement('div');
            modal.id = 'color-picker-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); display: flex; justify-content: center;
                align-items: center; z-index: 1000;
            `;
            
            const picker = document.createElement('div');
            picker.style.cssText = `
                background: #1a1a1a; padding: 30px; border-radius: 0; 
                border: 3px solid #00C07A; box-shadow: 0 0 30px #00C07A;
                display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
                font-family: 'Courier New', monospace;
            `;
            
            // Add color options including "no color"
            const colorOptions = [
                { name: 'No Color', value: '', style: 'background: #122026; border: 2px solid #666; color: #00C07A;' },
                { name: 'Yellow', value: 'yellow', style: 'background: #332200; border: 2px solid #ffff00; color: #ffff77;' },
                { name: 'Blue', value: 'blue', style: 'background: #001133; border: 2px solid #0088ff; color: #77ccff;' },
                { name: 'Green', value: 'green', style: 'background: #003300; border: 2px solid #00ff00; color: #77ff77;' },
                { name: 'Red', value: 'red', style: 'background: #330000; border: 2px solid #ff0000; color: #ff7777;' },
                { name: 'Orange', value: 'orange', style: 'background: #331100; border: 2px solid #ff8800; color: #ffaa77;' },
                { name: 'Purple', value: 'purple', style: 'background: #220033; border: 2px solid #aa00ff; color: #cc77ff;' }
            ];
            
            colorOptions.forEach(color => {
                const btn = document.createElement('button');
                btn.textContent = color.name;
                btn.style.cssText = `
                    ${color.style} 
                    padding: 15px; border-radius: 0; cursor: pointer;
                    font-family: 'Courier New', monospace; text-transform: uppercase;
                    font-size: 12px; font-weight: bold; transition: all 0.3s;
                `;
                btn.addEventListener('mouseenter', () => {
                    btn.style.boxShadow = '0 0 10px currentColor';
                });
                btn.addEventListener('mouseleave', () => {
                    btn.style.boxShadow = 'none';
                });
                btn.addEventListener('click', () => {
                    rerollWithColor(index, color.value);
                    document.body.removeChild(modal);
                });
                picker.appendChild(btn);
            });
            
            modal.appendChild(picker);
            document.body.appendChild(modal);
        }

        // Reroll challenge with selected color
        function rerollWithColor(index, selectedColor) {
            const cell = gameState.grid[index];

            // Remove the old challenge ID from used challenges
            if (cell.challenge && cell.challenge.id) {
                gameState.usedChallenges.delete(cell.challenge.id);
            }

            cell.color = selectedColor;
            
            const seed = gameState.seed + index + Date.now();
            const rng = new SeededRandom(seed);
            cell.challenge = selectChallenge(7 - cell.row, cell.col + 1, selectedColor, rng);
            
            // Don't delete the new challenge ID - selectChallenge already added it
            
            gameState.resources.dice--;
            showNotification('🎲 Challenge rerolled with color!');
            
            gameState.selectedResource = null;
            document.querySelectorAll('.resource-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            updateResourceDisplay();
            renderGrid();
        }

        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize email system
            emailSystem.init();
            
            // Mode selection
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    gameState.mode = e.target.id;
                    initGame();
                });
            });

            // Resource selection
            document.getElementById('gems-btn').addEventListener('click', () => {
                if (gameState.resources.gems > 0) {
                    toggleResourceSelection('gems');
                }
            });

            document.getElementById('keys-btn').addEventListener('click', () => {
                if (gameState.resources.keys > 0) {
                    toggleResourceSelection('keys');
                }
            });

            document.getElementById('dice-btn').addEventListener('click', () => {
                if (gameState.resources.dice > 0) {
                    toggleResourceSelection('dice');
                }
            });

            // New game button
            document.getElementById('new-game-btn').addEventListener('click', () => initGame(true));

            // Days counter for multi modes
            document.getElementById('days-counter').addEventListener('input', updateScoreDisplay);

            // Share button
            document.getElementById('share-btn').addEventListener('click', copyResult);

            // Handle seed toggle changes
            document.getElementById('daily-seed-toggle').addEventListener('change', (e) => {
                useRandomSeed = !e.target.checked;
                const manualContainer = document.getElementById('manual-seed-container');
                
                if (useRandomSeed) {
                    randomSeed = Math.random().toString(36).substring(7);
                    manualContainer.style.display = 'block';
                } else {
                    manualContainer.style.display = 'none';
                }
            });

            document.getElementById('apply-seed-btn').addEventListener('click', () => {
                const manualSeed = document.getElementById('manual-seed').value.trim();
                if (manualSeed) {
                    randomSeed = manualSeed;
                    initGame();
                }
            });

            // Help modal
            document.getElementById('help-btn').addEventListener('click', () => {
                document.getElementById('help-modal').style.display = 'flex';
            });

            document.getElementById('help-close').addEventListener('click', () => {
                document.getElementById('help-modal').style.display = 'none';
            });

            // Close help modal when clicking outside
            document.getElementById('help-modal').addEventListener('click', (e) => {
                if (e.target.id === 'help-modal') {
                    document.getElementById('help-modal').style.display = 'none';
                }
            });
        

            // Initialize first game
            initGame();
        });

        // Toggle resource selection
        function toggleResourceSelection(resource) {
            document.querySelectorAll('.resource-item').forEach(item => {
                item.classList.remove('selected');
            });

            if (gameState.selectedResource === resource) {
                gameState.selectedResource = null;
            } else {
                gameState.selectedResource = resource;
                document.getElementById(`${resource}-btn`).classList.add('selected');
            }
        }

    </script>
</body>
</html>